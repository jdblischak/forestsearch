% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/plot_km_band_forestsearch.R
\name{plot_km_band_forestsearch}
\alias{plot_km_band_forestsearch}
\title{Plot Kaplan-Meier Survival Difference Bands for ForestSearch Subgroups}
\usage{
plot_km_band_forestsearch(
  df,
  fs.est = NULL,
  sg_cols = NULL,
  sg_labels = NULL,
  sg_colors = NULL,
  itt_color = "azure3",
  outcome.name = "tte",
  event.name = "event",
  treat.name = "treat",
  xlabel = "Time",
  ylabel = "Survival differences",
  yseq_length = 5,
  draws_band = 1000,
  tau_add = NULL,
  by_risk = 6,
  risk_cex = 0.75,
  risk_delta = 0.035,
  risk_pad = 0.015,
  ymax_pad = 0.11,
  show_legend = TRUE,
  legend_pos = "topleft",
  legend_cex = 0.75,
  ref_subgroups = NULL,
  verbose = FALSE
)
}
\arguments{
\item{df}{Data frame. The analysis dataset containing all required variables
including subgroup indicator columns.}

\item{fs.est}{A forestsearch object containing the identified subgroup,
or \code{NULL} if using pre-defined subgroup indicators.}

\item{sg_cols}{Character vector. Names of columns in \code{df} containing
subgroup indicators (0/1). These columns must already exist in \code{df}.
If \code{NULL} and \code{fs.est} is provided, columns will be created
automatically. Default: \code{NULL}}

\item{sg_labels}{Character vector. Subsetting expressions for each subgroup,
corresponding to \code{sg_cols}. These are passed to
\code{plotKM.band_subgroups()} which evaluates them as R expressions
(e.g., \code{"age < 65"}, \code{"er <= 0"}, \code{"Qrecommend == 1"}).
Must be same length as \code{sg_cols}.
Default: \code{NULL} (auto-generated as \code{"colname == 1"}).}

\item{sg_colors}{Character vector. Colors for each subgroup curve,
corresponding to \code{sg_cols}. Must be same length as \code{sg_cols}.
Default: \code{NULL} (uses default color palette).}

\item{itt_color}{Character. Color for ITT population band.
Default: \code{"azure3"}.}

\item{outcome.name}{Character. Name of time-to-event column.
Default: \code{"tte"}.}

\item{event.name}{Character. Name of event indicator column.
Default: \code{"event"}.}

\item{treat.name}{Character. Name of treatment column.
Default: \code{"treat"}.}

\item{xlabel}{Character. X-axis label. Default: \code{"Time"}.}

\item{ylabel}{Character. Y-axis label. Default: \code{"Survival differences"}.}

\item{yseq_length}{Integer. Number of y-axis tick marks.
Default: \code{5}.}

\item{draws_band}{Integer. Number of bootstrap draws for confidence band.
Default: \code{1000}.}

\item{tau_add}{Numeric. Time horizon for the plot. If \code{NULL},
auto-calculated from data. Default: \code{NULL}.}

\item{by_risk}{Numeric. Interval for risk table. Default: \code{6}.}

\item{risk_cex}{Numeric. Character expansion for risk table text.
Default: \code{0.75}.}

\item{risk_delta}{Numeric. Vertical spacing for risk table.
Default: \code{0.035}.}

\item{risk_pad}{Numeric. Padding for risk table. Default: \code{0.015}.}

\item{ymax_pad}{Numeric. Y-axis maximum padding. Default: \code{0.11}.}

\item{show_legend}{Logical. Whether to display the legend.
Default: \code{TRUE}.}

\item{legend_pos}{Character. Legend position (e.g., "topleft", "bottomright").
Default: \code{"topleft"}.}

\item{legend_cex}{Numeric. Character expansion for legend text.
Default: \code{0.75}.}

\item{ref_subgroups}{Named list. Optional additional reference subgroups to
include. Each element should be a list with:
\describe{
\item{subset_expr}{Character. R expression to define subgroup (e.g., "age < 65")}
\item{label}{Character. Display label (optional, defaults to subset_expr)}
\item{color}{Character. Color for the curve}
}
The function automatically creates indicator columns from the expressions.
Default: \code{NULL}.}

\item{verbose}{Logical. Print diagnostic messages. Default: \code{FALSE}.}
}
\value{
Invisibly returns a list containing:
\describe{
\item{df}{The modified data frame with subgroup indicators}
\item{sg_cols}{Character vector of subgroup column names used}
\item{sg_labels}{Character vector of subgroup labels used}
\item{sg_colors}{Character vector of colors used}
\item{sg_harm_definition}{The subgroup definition extracted from fs.est}
\item{ref_subgroups}{The reference subgroups list (if provided)}
}
}
\description{
Creates Kaplan-Meier survival difference band plots comparing the identified
ForestSearch subgroup (sg.harm) and its complement against the ITT population.
This function wraps \code{plotKM.band_subgroups()} from the weightedsurv
package, automatically extracting subgroup definitions from ForestSearch
results.
}
\details{
This function simplifies the workflow of creating KM survival difference
band plots for ForestSearch-identified subgroups. It can work in two modes:

\strong{Mode 1: With ForestSearch result (\code{fs.est} provided)}
\enumerate{
\item Extracts the subgroup definition from the ForestSearch result
\item Creates binary indicator columns (Qrecommend, Brecommend) in \code{df}
\item Generates appropriate labels from the subgroup definition
\item Calls \code{plotKM.band_subgroups()} with configured parameters
}

\strong{Mode 2: With pre-defined columns (\code{sg_cols} provided)}
\enumerate{
\item Uses existing indicator columns in \code{df}
\item Requires \code{sg_labels} and \code{sg_colors} to match \code{sg_cols}
}

The sg.harm subgroup (Qrecommend) represents patients with questionable
treatment benefit (where \code{treat.recommend == 0} in ForestSearch output).
The complement (Brecommend) represents patients recommended for treatment.
}
\note{
This function requires the \pkg{weightedsurv} package, which can be
installed from GitHub: \code{devtools::install_github("larry-leon/weightedsurv")}
}
\section{Subgroup Extraction}{

When \code{fs.est} is provided, the subgroup definition is extracted from:
\itemize{
\item \code{fs.est$grp.consistency$out_sg$sg.harm_label} - Human-readable labels
\item \code{fs.est$sg.harm} - Technical factor names (fallback)
\item \code{fs.est$df.est$treat.recommend} - Subgroup membership indicator
}
}

\examples{
\dontrun{
# Mode 1: Using ForestSearch result (auto-creates Qrecommend/Brecommend)
# This will use labels "Qrecommend == 1" and "Brecommend == 1"
plot_km_band_forestsearch(
  df = df.analysis,
  fs.est = fs_result,
  outcome.name = "os_months",
  event.name = "os_event",
  treat.name = "treatment"
)

# Mode 1 with additional reference subgroups (auto-creates columns)
ref_sgs <- list(
  age_young = list(subset_expr = "age < 65", color = "brown"),
  age_old = list(subset_expr = "age >= 65", color = "grey")
)

plot_km_band_forestsearch(
  df = df.analysis,
  fs.est = fs_result,
  ref_subgroups = ref_sgs,
  outcome.name = "os_months",
  event.name = "os_event",
  treat.name = "treatment",
  tau_add = 60,
  by_risk = 6
)

# Mode 2: Using pre-defined subgroup columns with expression labels
# Note: sg_labels must be valid R expressions that evaluate against df
df.analysis$age_lt65 <- ifelse(df.analysis$age < 65, 1, 0)
df.analysis$age_ge65 <- ifelse(df.analysis$age >= 65, 1, 0)
df.analysis$Qrecommend <- ifelse(df.analysis$er <= 0, 1, 0)
df.analysis$Brecommend <- ifelse(df.analysis$er > 0, 1, 0)

plot_km_band_forestsearch(
  df = df.analysis,
  sg_cols = c("age_lt65", "age_ge65", "Qrecommend", "Brecommend"),
  sg_labels = c("age < 65", "age >= 65", "er <= 0", "er > 0"),
  sg_colors = c("brown", "grey", "blue", "red"),
  outcome.name = "os_months",
  event.name = "os_event",
  treat.name = "treatment",
  tau_add = 60,
  by_risk = 6
)
}

}
\seealso{
\code{\link{forestsearch}} for running the subgroup analysis
\code{\link{plot_sg_weighted_km}} for weighted KM plots
\code{\link{plot_sg_results}} for comprehensive subgroup visualization
}
