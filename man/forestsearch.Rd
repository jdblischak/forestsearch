% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/forest_search_revised.R
\name{forestsearch}
\alias{forestsearch}
\title{ForestSearch: Exploratory Subgroup Identification}
\usage{
forestsearch(
  df.analysis,
  outcome.name = "tte",
  event.name = "event",
  treat.name = "treat",
  id.name = "id",
  potentialOutcome.name = NULL,
  flag_harm.name = NULL,
  confounders.name = NULL,
  parallel_args = list(plan = "callr", workers = 6, show_message = TRUE),
  df.predict = NULL,
  df.test = NULL,
  is.RCT = TRUE,
  seedit = 8316951,
  est.scale = "hr",
  use_lasso = TRUE,
  use_grf = TRUE,
  grf_res = NULL,
  grf_cuts = NULL,
  max_n_confounders = 1000,
  grf_depth = 2,
  dmin.grf = 12,
  frac.tau = 0.6,
  conf_force = NULL,
  defaultcut_names = NULL,
  cut_type = "default",
  exclude_cuts = NULL,
  replace_med_grf = FALSE,
  cont.cutoff = 4,
  conf.cont_medians = NULL,
  conf.cont_medians_force = NULL,
  n.min = 60,
  hr.threshold = 1.25,
  hr.consistency = 1,
  sg_focus = "hr",
  fs.splits = 1000,
  m1.threshold = Inf,
  pconsistency.threshold = 0.9,
  stop_threshold = 0.95,
  showten_subgroups = FALSE,
  d0.min = 12,
  d1.min = 12,
  max.minutes = 3,
  minp = 0.025,
  details = FALSE,
  maxk = 2,
  by.risk = 12,
  plot.sg = FALSE,
  plot.grf = FALSE,
  max_subgroups_search = 10,
  vi.grf.min = -0.2,
  use_twostage = TRUE,
  twostage_args = list()
)
}
\arguments{
\item{df.analysis}{Data frame. Analysis dataset with required columns.}

\item{outcome.name}{Character. Name of time-to-event outcome variable. Default "tte".}

\item{event.name}{Character. Name of event indicator (1=event, 0=censored). Default "event".}

\item{treat.name}{Character. Name of treatment variable (1=treatment, 0=control). Default "treat".}

\item{id.name}{Character. Name of subject ID variable. Default "id".}

\item{potentialOutcome.name}{Character. Name of potential outcome variable (optional).}

\item{flag_harm.name}{Character. Name of true harm flag for simulations (optional).}

\item{confounders.name}{Character vector. Names of candidate subgroup-defining variables.}

\item{parallel_args}{List. Parallel processing configuration:
\describe{
\item{plan}{Character. One of "multisession", "multicore", "callr", "sequential"}
\item{workers}{Integer. Number of parallel workers}
\item{show_message}{Logical. Show parallel setup messages}
}}

\item{df.predict}{Data frame. Prediction dataset (optional).}

\item{df.test}{Data frame. Test dataset (optional).}

\item{is.RCT}{Logical. Is this a randomized controlled trial? Default TRUE.}

\item{seedit}{Integer. Random seed. Default 8316951.}

\item{est.scale}{Character. Estimation scale ("hr" or "rmst"). Default "hr".}

\item{use_lasso}{Logical. Use LASSO for variable selection. Default TRUE.}

\item{use_grf}{Logical. Use GRF for variable importance. Default TRUE.}

\item{grf_res}{GRF results object (optional, for reuse).}

\item{grf_cuts}{List. Custom GRF cut points (optional).}

\item{max_n_confounders}{Integer. Maximum confounders to consider. Default 1000.}

\item{grf_depth}{Integer. GRF tree depth. Default 2.}

\item{dmin.grf}{Integer. Minimum events for GRF. Default 12.}

\item{frac.tau}{Numeric. Fraction of tau for RMST. Default 0.6.}

\item{conf_force}{Character vector. Variables to force include (optional).}

\item{defaultcut_names}{Character vector. Default cut variable names (optional).}

\item{cut_type}{Character. Cut type ("default" or "custom"). Default "default".}

\item{exclude_cuts}{Character vector. Variables to exclude from cutting (optional).}

\item{replace_med_grf}{Logical. Replace median with GRF cuts. Default FALSE.}

\item{cont.cutoff}{Integer. Cutoff for continuous vs categorical. Default 4.}

\item{conf.cont_medians}{Named numeric vector. Median values for continuous variables (optional).}

\item{conf.cont_medians_force}{Named numeric vector. Forced median values (optional).}

\item{n.min}{Integer. Minimum subgroup size. Default 60.}

\item{hr.threshold}{Numeric. Minimum HR for candidate subgroups. Default 1.25.}

\item{hr.consistency}{Numeric. Minimum HR for consistency validation. Default 1.0.}

\item{sg_focus}{Character. Subgroup selection focus. One of "hr", "hrMaxSG", "maxSG",
"hrMinSG", "minSG". Default "hr".}

\item{fs.splits}{Integer. Number of splits for consistency evaluation (or maximum
splits when \code{use_twostage = TRUE}). Default 1000.}

\item{m1.threshold}{Numeric. Maximum median survival threshold. Default Inf.}

\item{pconsistency.threshold}{Numeric. Minimum consistency proportion. Default 0.90.}

\item{showten_subgroups}{Logical. Show top 10 subgroups. Default FALSE.}

\item{d0.min}{Integer. Minimum control arm events. Default 12.}

\item{d1.min}{Integer. Minimum treatment arm events. Default 12.}

\item{max.minutes}{Numeric. Maximum search time in minutes. Default 3.}

\item{minp}{Numeric. Minimum prevalence threshold. Default 0.025.}

\item{details}{Logical. Print progress details. Default FALSE.}

\item{maxk}{Integer. Maximum number of factors per subgroup. Default 2.}

\item{by.risk}{Integer. Risk table interval. Default 12.}

\item{plot.sg}{Logical. Plot subgroup survival curves. Default FALSE.}

\item{plot.grf}{Logical. Plot GRF results. Default FALSE.}

\item{max_subgroups_search}{Integer. Maximum subgroups to evaluate. Default 10.}

\item{vi.grf.min}{Numeric. Minimum GRF variable importance. Default -0.2.}

\item{use_twostage}{Logical. Use two-stage sequential consistency algorithm for
improved performance. Default FALSE for backward compatibility. When TRUE,
\code{fs.splits} becomes the maximum number of splits, and early stopping
is enabled. See Details.}

\item{twostage_args}{List. Parameters for two-stage algorithm (only used when
\code{use_twostage = TRUE}):
\describe{
\item{n.splits.screen}{Integer. Splits for Stage 1 screening. Default 30.}
\item{screen.threshold}{Numeric. Consistency threshold for Stage 1. Default
is automatically calculated to provide ~2.5 SE margin.}
\item{batch.size}{Integer. Splits per batch in Stage 2. Default 20.}
\item{conf.level}{Numeric. Confidence level for early stopping. Default 0.95.}
\item{min.valid.screen}{Integer. Minimum valid Stage 1 splits. Default 10.}
}}
}
\value{
A list of class "forestsearch" containing:
\describe{
\item{grp.consistency}{Consistency evaluation results including:
\itemize{
\item out_sg: Selected subgroup based on sg_focus
\item sg_focus: Focus criterion used
\item df_flag: Treatment recommendations
\item algorithm: "twostage" or "fixed"
\item n_candidates_evaluated: Number evaluated
\item n_passed: Number passing threshold
}}
\item{find.grps}{Subgroup search results}
\item{confounders.candidate}{Candidate confounders considered}
\item{confounders.evaluated}{Confounders after variable selection}
\item{df.est}{Analysis data with treatment recommendations}
\item{df.predict}{Prediction data with recommendations (if provided)}
\item{df.test}{Test data with recommendations (if provided)}
\item{minutes_all}{Total computation time}
\item{grf_res}{GRF results object}
\item{sg_focus}{Subgroup focus criterion used}
\item{sg.harm}{Selected subgroup definition}
\item{grf_cuts}{GRF cut points used}
\item{prop_maxk}{Proportion of max combinations searched}
\item{max_sg_est}{Maximum subgroup HR estimate}
\item{grf_plot}{GRF plot object (if plot.grf = TRUE)}
\item{args_call_all}{All arguments for reproducibility}
}
}
\description{
Identifies subgroups with differential treatment effects in clinical trials
using a combination of Generalized Random Forests (GRF), LASSO variable
selection, and exhaustive combinatorial search with split-sample validation.
}
\details{
\strong{Algorithm Overview:}
\enumerate{
\item \strong{Variable Selection}: GRF identifies variables with treatment
effect heterogeneity; LASSO selects most predictive
\item \strong{Subgroup Discovery}: Exhaustive search over factor combinations
up to \code{maxk}
\item \strong{Consistency Validation}: Split-sample validation ensures
reproducibility
\item \strong{Selection}: Choose subgroup based on \code{sg_focus} criterion
}

\strong{Two-Stage Consistency Algorithm:}
When \code{use_twostage = TRUE}, the consistency evaluation uses an optimized
algorithm that can provide 3-10x speedup:
\itemize{
\item \strong{Stage 1}: Quick screening with \code{n.splits.screen} splits
eliminates clearly non-viable candidates
\item \strong{Stage 2}: Sequential batched evaluation with early stopping
for candidates passing Stage 1
}

The two-stage algorithm is recommended for:
\itemize{
\item Exploratory analyses with many candidate subgroups
\item Large \code{fs.splits} values (>200)
\item Iterative model development
}

For final regulatory submissions, \code{use_twostage = FALSE} may be preferred
for exact reproducibility.
}
\examples{
\dontrun{
# Example 1: Standard analysis (backward compatible)
result <- forestsearch(
  df.analysis = trial_data,
  sg_focus = "hr",
  hr.threshold = 1.25,
  pconsistency.threshold = 0.90,
  fs.splits = 400,
  details = TRUE
)

# Example 2: Fast exploratory analysis with two-stage
result_fast <- forestsearch(
  df.analysis = trial_data,
  sg_focus = "maxSG",
  hr.threshold = 1.15,
  pconsistency.threshold = 0.85,
  fs.splits = 500,
  use_twostage = TRUE,
  details = TRUE
)

# Example 3: Two-stage with custom parameters
result_custom <- forestsearch(
  df.analysis = trial_data,
  sg_focus = "hr",
  hr.threshold = 1.3,
  pconsistency.threshold = 0.95,
  fs.splits = 600,
  use_twostage = TRUE,
  twostage_args = list(
    n.splits.screen = 50,
    batch.size = 25,
    conf.level = 0.99
  ),
  parallel_args = list(plan = "multisession", workers = 4),
  details = TRUE
)
}

}
\references{
\itemize{
\item FDA Guidance for Industry: Enrichment Strategies for Clinical Trials
\item Athey & Imbens (2016). Recursive partitioning for heterogeneous
causal effects. PNAS.
\item Wager & Athey (2018). Estimation and inference of heterogeneous
treatment effects using random forests. JASA.
}
}
\seealso{
\code{\link{subgroup.consistency}} for consistency evaluation details
\code{\link{forestsearch_bootstrap_dofuture}} for bootstrap inference
\code{\link{forestsearch_Kfold}} for cross-validation
}
