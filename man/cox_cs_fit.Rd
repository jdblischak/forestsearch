% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/cox_spline_fit.R
\name{cox_cs_fit}
\alias{cox_cs_fit}
\title{Fit Cox Model with Cubic Spline for Treatment Effect Heterogeneity}
\usage{
cox_cs_fit(
  df,
  tte_name = "os_time",
  event_name = "os_event",
  treat_name = "treat",
  strata_name = NULL,
  z_name = "bm",
  alpha = 0.2,
  spline_df = 3,
  z_max = Inf,
  z_by = 1,
  z_window = 0,
  z_quantile = 0.9,
  show_plot = TRUE,
  plot_params = NULL,
  truebeta_name = NULL,
  verbose = TRUE
)
}
\arguments{
\item{df}{Data frame containing survival data}

\item{tte_name}{Character string specifying time-to-event variable name.
Default: "os_time"}

\item{event_name}{Character string specifying event indicator variable name
(1=event, 0=censored). Default: "os_event"}

\item{treat_name}{Character string specifying treatment variable name
(1=treated, 0=control). Default: "treat"}

\item{strata_name}{Character string specifying stratification variable name.
If NULL, no stratification is used. Default: NULL}

\item{z_name}{Character string specifying continuous covariate name for
effect modification. Default: "bm"}

\item{alpha}{Numeric value for confidence level (two-sided). Default: 0.20
(80\% confidence intervals)}

\item{spline_df}{Integer specifying degrees of freedom for natural spline.
Default: 3}

\item{z_max}{Numeric maximum value for z in predictions. Values beyond this
are truncated. Default: Inf (no truncation)}

\item{z_by}{Numeric increment for z values in prediction grid. Default: 1}

\item{z_window}{Numeric half-width for counting observations near each z value.
Default: 0.0 (exact matches only)}

\item{z_quantile}{Numeric quantile (0-1) for upper limit of z profile.
Default: 0.90 (90th percentile)}

\item{show_plot}{Logical indicating whether to display plot. Default: TRUE}

\item{plot_params}{List of plotting parameters (see Details). Default: NULL}

\item{truebeta_name}{Character string specifying variable containing true
log(HR) values for validation/simulation. Default: NULL}

\item{verbose}{Logical indicating whether to print diagnostic information.
Default: TRUE}
}
\value{
List containing:
\describe{
\item{z_profile}{Vector of z values where treatment effect is estimated}
\item{loghr_est}{Point estimates of log(HR) at each z value}
\item{loghr_lower}{Lower confidence bound}
\item{loghr_upper}{Upper confidence bound}
\item{se_loghr}{Standard errors of log(HR) estimates}
\item{counts_profile}{Number of observations near each z value}
\item{cox_primary}{Log(HR) from standard Cox model (no interaction)}
\item{model_fit}{The fitted coxph model object}
\item{spline_basis}{The natural spline basis object}
}
}
\description{
Estimates treatment effects as a function of a continuous covariate using
a Cox proportional hazards model with natural cubic splines. The function
models treatment-by-covariate interactions to detect effect modification.
}
\details{
\subsection{Model Structure}{

The function fits:
\deqn{h(t|Z,A) = h_0(t) \exp(\beta_0 A + f(Z) + g(Z) \cdot A)}

Where:
\itemize{
\item A is treatment (0/1)
\item Z is the continuous effect modifier
\item f(Z) is modeled with natural splines (main effect)
\item g(Z) is modeled with natural splines (interaction)
\item The log hazard ratio is: \eqn{\beta(Z) = \beta_0 + g(Z)}
}
}

\subsection{Plot Parameters}{

The \code{plot_params} argument accepts a list with:
\itemize{
\item \code{xlab}: x-axis label
\item \code{main_title}: plot title
\item \code{ylimit}: y-axis limits c(min, max)
\item \code{y_pad_zero}: padding below zero line
\item \code{y_delta}: extra space for count labels
\item \code{cex_legend}: legend text size
\item \code{cex_count}: count text size
\item \code{show_cox_primary}: show standard Cox estimate line
\item \code{show_null}: show null effect line (log(HR)=0)
\item \code{show_target}: show target effect line (e.g., log(0.80))
}
}
}
\examples{
\dontrun{
# Simulate data
set.seed(123)
df <- data.frame(
  os_time = rexp(500, 0.01),
  os_event = rbinom(500, 1, 0.7),
  treat = rbinom(500, 1, 0.5),
  bm = rnorm(500, 50, 10)
)

# Fit model
result <- cox_cs_fit(df, z_name = "bm", alpha = 0.20)

# Custom plotting
result <- cox_cs_fit(
  df,
  z_name = "bm",
  plot_params = list(
    xlab = "Biomarker Level",
    main_title = "Treatment Effect by Biomarker",
    cex_legend = 1.2
  )
)
}

}
