% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/oc_analyses_gbsg_refactored.R
\name{run_simulation_analysis}
\alias{run_simulation_analysis}
\title{Run Single Simulation Analysis}
\usage{
run_simulation_analysis(
  sim_id,
  dgm,
  n_sample,
  max_follow = Inf,
  muC_adj = 0,
  confounders_base = c("v1", "v2", "v3", "v4", "v5", "v6", "v7"),
  n_add_noise = 0L,
  run_fs = TRUE,
  run_fs_grf = TRUE,
  run_grf = TRUE,
  fs_params = list(),
  grf_params = list(),
  cox_formula = NULL,
  cox_formula_adj = NULL,
  n_sims_total = NULL,
  seed_base = 8316951L,
  verbose = FALSE,
  verbose_n = NULL,
  debug = FALSE
)
}
\arguments{
\item{sim_id}{Integer. Simulation index for seed offset and tracking}

\item{dgm}{A DGM object from \code{\link{create_gbsg_dgm}} or similar}

\item{n_sample}{Integer. Sample size for simulation}

\item{max_follow}{Numeric. Maximum follow-up time. Default: Inf}

\item{muC_adj}{Numeric. Censoring adjustment. Default: 0}

\item{confounders_base}{Character vector. Base confounder names}

\item{n_add_noise}{Integer. Number of noise variables to add. Default: 0}

\item{run_fs}{Logical. Run ForestSearch with LASSO variable selection.
Default: TRUE. Analysis label: "FS"}

\item{run_fs_grf}{Logical. Run ForestSearch with LASSO + GRF variable selection.
Default: TRUE. Analysis label: "FSlg"}

\item{run_grf}{Logical. Run standalone GRF analysis (grf.subg.harm.survival).
Default: TRUE. Analysis label: "GRF"}

\item{fs_params}{List. ForestSearch parameters (overrides all defaults including
use_lasso/use_grf). User-provided values take precedence over analysis-type defaults.
For example, \code{fs_params = list(hr.threshold = 1.5, use_twostage = TRUE)} will
apply to both FS and FSlg analyses.}

\item{grf_params}{List. GRF parameters for standalone GRF analysis (overrides defaults).
Accepts all parameters for \code{grf.subg.harm.survival()}: n.min, dmin.grf,
frac.tau, maxdepth, RCT, sg.criterion, seedit, outcome.name, event.name,
treat.name, id.name. User-provided values take precedence over defaults.}

\item{cox_formula}{Formula. Cox model formula for estimation}

\item{cox_formula_adj}{Formula. Adjusted Cox model formula}

\item{n_sims_total}{Integer. Total simulations (for progress display)}

\item{seed_base}{Integer. Base random seed. Default: 8316951}

\item{verbose}{Logical. Print progress. Default: FALSE}

\item{verbose_n}{Integer. Only print verbose output for first N simulations.
Default: NULL (print for all simulations when verbose = TRUE)}

\item{debug}{Logical. Print detailed debugging information. Default: FALSE}
}
\value{
A data.table with analysis results for all requested methods,
including both HR and AHR metrics. Contains columns:
\describe{
\item{sim}{Simulation ID}
\item{sizeH_true, propH_true}{True harm subgroup size/proportion in sample}
\item{analysis}{Analysis method: "FS", "FSlg", or "GRF"}
\item{any.H}{1 if subgroup identified, 0 otherwise}
\item{size.H, size.Hc}{Size of identified H and complement}
\item{hr.H.true, hr.H.hat}{True and estimated HR in identified H}
\item{hr.Hc.true, hr.Hc.hat}{True and estimated HR in identified Hc}
\item{ahr.H.true, ahr.H.hat}{True and estimated AHR in identified H}
\item{sens, spec, ppv, npv}{Classification metrics}
}
}
\description{
Executes ForestSearch and/or GRF analysis on a single simulated dataset.
This is the core function called within a simulation loop.
}
\details{
Aligned with create_gbsg_dgm() and generate_aft_dgm_flex() output structures.
\subsection{Analysis Methods}{

The function can run up to three analysis types:
\itemize{
\item \strong{FS}: ForestSearch with LASSO variable selection only
(default: use_lasso = TRUE, use_grf = FALSE)
\item \strong{FSlg}: ForestSearch with LASSO + GRF variable selection
(default: use_lasso = TRUE, use_grf = TRUE)
\item \strong{GRF}: Standalone GRF-based subgroup identification using
grf.subg.harm.survival()
}
}

\subsection{Parameter Merging Order}{

Parameters are merged in the following order (later values override earlier):
\enumerate{
\item \code{default_fs_params()} - package defaults
\item Analysis-type-specific defaults (use_lasso/use_grf for FS vs FSlg)
\item User's \code{fs_params} - \strong{final authority}
}

This means if you pass \code{fs_params = list(use_grf = TRUE)}, it will
override the FS analysis default of \code{use_grf = FALSE}.
}

\subsection{Output Column Naming Convention}{

The output distinguishes between:
\itemize{
\item \strong{True subgroup from DGM}: sizeH_true, propH_true (known from data generation)
\item \strong{Identified subgroup}: size.H, hr.H.hat (estimated by analysis)
}
}
}
\examples{
\dontrun{
# Create DGM (aligned version)
dgm <- create_gbsg_dgm(model = "alt", k_inter = 2, verbose = TRUE)

# Run single simulation with LASSO only
result <- run_simulation_analysis(
  sim_id = 1,
  dgm = dgm,
  n_sample = 500,
  confounders_base = c("v1", "v2", "v3", "v4", "v5", "v6", "v7"),
  run_fs = TRUE,      # LASSO only
  run_fs_grf = FALSE, # Skip LASSO+GRF
  run_grf = FALSE,    # Skip standalone GRF
  verbose = TRUE
)

# Run all three analysis types
result_all <- run_simulation_analysis(
  sim_id = 1,
  dgm = dgm,
  n_sample = 500,
  run_fs = TRUE,
  run_fs_grf = TRUE,
  run_grf = TRUE,
  verbose = TRUE
)
# result_all has 3 rows: one for FS, one for FSlg, one for GRF

# With use_twostage = TRUE for faster analysis
result_fast <- run_simulation_analysis(
  sim_id = 1,
  dgm = dgm,
  n_sample = 500,
  fs_params = list(use_twostage = TRUE),
  verbose = TRUE
)
}

}
