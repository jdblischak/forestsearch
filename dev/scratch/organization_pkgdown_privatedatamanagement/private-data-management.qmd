---
title: "Managing Private Datasets in R Package Development"
subtitle: "A Guide for ForestSearch and Similar Packages"
author: "Development Notes"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: false
    code-tools: true
---

## Overview

This guide describes best practices for managing sensitive or proprietary datasets during R package development, with a focus on:

1. Keeping data private during local development
2. Maintaining CRAN compliance
3. Sharing data with authorized users after package publication

## Phase 1: Local Development

### Directory Structure

Store private datasets in a `dev/private/` directory that is excluded from both Git tracking and the R package build:

```
ForestSearch/
├── R/
├── data/
├── inst/
├── dev/
│   ├── private/
│   │   ├── case_study.csv
│   │   └── README.md
│   └── scripts/
├── .gitignore
└── .Rbuildignore
```

### Git Configuration

Add `dev/private/` to `.gitignore` to prevent accidental commits:

```bash
# .gitignore
dev/private/
```

If the directory is already tracked, remove it from Git while keeping local files:

```bash
git rm -r --cached dev/private
git commit -m "Stop tracking dev/private"
git push
```

### R Build Configuration

Add to `.Rbuildignore` to exclude from package builds:

```bash
# .Rbuildignore
^dev$
```

### Accessing Data During Development

Create a helper script in `dev/scripts/` for loading private data:

```{r}
#| eval: false

# dev/scripts/load_private_data.R
load_private_data <- function(filename) {
  filepath <- file.path("dev", "private", filename)

  if (!file.exists(filepath)) {
    stop(
      "Private data file not found: ", filename, "\n",
      "Contact package maintainer for access.",
      call. = FALSE
    )
  }

  ext <- tolower(tools::file_ext(filename))

  switch(ext,
    csv = read.csv(filepath),
    rds = readRDS(filepath),
    rda = {
      env <- new.env()
      load(filepath, envir = env)
      as.list(env)
    },
    stop("Unsupported file type: ", ext, call. = FALSE)
  )
}

# Usage
case_study <- load_private_data("case_study.csv")
```

## Phase 2: CRAN Submission

### Data Handling Options

Before CRAN submission, decide which datasets to include:

| Data Type | Location | Included in Package |
|-----------|----------|---------------------|
| Example data (public) | `data/` | Yes |
| Internal data (hidden) | `R/sysdata.rda` | Yes |
| Raw data + scripts | `data-raw/` | No |
| Private data | `dev/private/` | No |

### Including Public Example Data

For datasets you want to share publicly:

```{r}
#| eval: false

# 1. Create data-raw directory
usethis::use_data_raw("example_trial")

# 2. In data-raw/example_trial.R:
example_trial <- data.frame(
  id = 1:100,
  time = rexp(100, 0.1),
  event = rbinom(100, 1, 0.7),
  treatment = rep(0:1, each = 50),
  biomarker = rnorm(100)
)

usethis::use_data(example_trial, overwrite = TRUE)

# 3. Document in R/data.R:
#' Example Clinical Trial Dataset
#'
#' A simulated dataset for demonstrating ForestSearch functionality.
#'
#' @format A data frame with 100 rows and 5 variables:
#' \describe{
#'   \item{id}{Patient identifier}
#'   \item{time}{Survival time}
#'   \item{event}{Event indicator (1 = event, 0 = censored)}
#'   \item{treatment}{Treatment arm (0 = control, 1 = treatment)}
#'   \item{biomarker}{Continuous biomarker value}
#' }
#' @examples
#' data(example_trial)
#' head(example_trial)
"example_trial"
```

### CRAN Size Requirements

- Total package size: < 5 MB
- Individual data files: as small as practical
- Use compression: `usethis::use_data(..., compress = "xz")`

## Phase 3: Post-Publication Sharing

After CRAN acceptance, use one of these methods to share private data with authorized users.

### Option A: Companion Data Package (Recommended)
  
Create a separate private package for the data.

#### Step 1: Create the Data Package

```{r}
#| eval: false

# Create new package
usethis::create_package("~/ForestSearchData")

# In the new package:
usethis::use_data_raw("case_study")
```

#### Step 2: Add Data and Documentation

```{r}
#| eval: false

# data-raw/case_study.R
case_study <- read.csv("path/to/case_study.csv")
usethis::use_data(case_study, overwrite = TRUE)
```

```{r}
#| eval: false

# R/data.R
#' Case Study Dataset
#'
#' Proprietary clinical trial data for ForestSearch analysis.
#' Access restricted to authorized users.
#'
#' @format A data frame with variables:
#' \describe{
#'   \item{patient_id}{Unique patient identifier}
#'   \item{...}{Additional variables}
#' }
#' @source Confidential clinical trial data
"case_study"
```

#### Step 3: Host on Private GitHub Repository

```bash
cd ~/ForestSearchData
git init
git add .
git commit -m "Initial commit"

# Create private repo on GitHub, then:
git remote add origin git@github.com:username/ForestSearchData.git
git push -u origin main
```

#### Step 4: Authorize Users

On GitHub:

1. Go to repository Settings
2. Click Collaborators
3. Add authorized users by GitHub username

#### Step 5: User Installation

Authorized users install with:

```{r}
#| eval: false

# Requires GitHub authentication
remotes::install_github("username/ForestSearchData")

# Then use:
library(ForestSearchData)
data("case_study")
```

### Option B: GitHub Release Asset

Attach data files to a GitHub release for manual download.

#### Step 1: Create Helper Function

Add to your main package:

```{r}
#| eval: false

#' Download Case Study Dataset
#'
#' Downloads the case study dataset from the package release assets.
#' Requires authorization for private releases.
#'
#' @param destdir Character. Destination directory. Default is current working
#'   directory.
#' @param version Character. Release version to download from. Default is
#'   "latest".
#'
#' @return Invisible file path to downloaded file.
#'
#' @export
#' @examples
#' \dontrun{
#' download_case_study()
#' case_study <- read.csv("case_study.csv")
#' }
download_case_study <- function(destdir = ".", version = "latest") {
  base_url <- "https://github.com/username/ForestSearch/releases"

  if (version == "latest") {
    url <- file.path(base_url, "latest", "download", "case_study.csv")
  } else {
    url <- file.path(base_url, "download", version, "case_study.csv")
  }

  destfile <- file.path(destdir, "case_study.csv")

  tryCatch(
    {
      download.file(url, destfile, mode = "wb", quiet = TRUE)
      message("Downloaded: ", destfile)
      invisible(destfile)
    },
    error = function(e) {
      stop(
        "Download failed. Ensure you have access to the repository.\n",
        "Contact the package maintainer for authorization.",
        call. = FALSE
      )
    }
  )
}
```

#### Step 2: Create GitHub Release

```bash
# Tag the release
git tag -a v1.0.0 -m "Version 1.0.0"
git push origin v1.0.0
```

On GitHub:

1. Go to Releases
2. Click Create new release
3. Select the tag
4. Attach `case_study.csv` as a binary asset
5. Publish release

### Option C: Cloud Storage Integration

For simple sharing without code.

#### Google Drive

```{r}
#| eval: false

#' Download Case Study from Google Drive
#'
#' @param destdir Destination directory.
#'
#' @return Invisible file path.
#'
#' @export
download_case_study_gdrive <- function(destdir = ".") {
  # File ID from shareable link
  file_id <- "your-file-id-here"
  url <- paste0(
    "https://drive.google.com/uc?export=download&id=", file_id
  )

  destfile <- file.path(destdir, "case_study.csv")
  download.file(url, destfile, mode = "wb")
  invisible(destfile)
}
```

#### Dropbox

```{r}
#| eval: false

#' Download Case Study from Dropbox
#'
#' @param destdir Destination directory.
#'
#' @return Invisible file path.
#'
#' @export
download_case_study_dropbox <- function(destdir = ".") {
  # Change dl=0 to dl=1 in Dropbox share link
  url <- "https://www.dropbox.com/s/xxxxx/case_study.csv?dl=1"

  destfile <- file.path(destdir, "case_study.csv")
  download.file(url, destfile, mode = "wb")
  invisible(destfile)
}
```

## Recommended Workflow Summary

```{mermaid}
flowchart TD
    A[Development Phase] --> B{Data Type?}
    B -->|Public| C[data/ directory]
    B -->|Private| D[dev/private/]

    D --> E[Add to .gitignore]
    E --> F[CRAN Submission]

    F --> G[Post-Publication]
    G --> H{Sharing Method?}

    H -->|Code Users| I[Companion Package<br/>Private GitHub Repo]
    H -->|Manual Download| J[GitHub Release Asset]
    H -->|Non-Technical| K[Cloud Storage Link]

    C --> L[Document in R/data.R]
    L --> F
```

## Security Considerations

### Do Not

- Commit sensitive data to public repositories
- Include API keys or credentials in code
- Share data without proper authorization agreements

### Do

- Use `.gitignore` consistently
- Verify `.gitignore` is working before commits: `git status`
- Use private repositories for sensitive data
- Document data access requirements clearly
- Maintain a record of authorized users

## Quick Reference

### Essential Files Configuration

**.gitignore**

```
dev/private/
*.csv
!data-raw/*.csv
```

**.Rbuildignore**

```
^dev$
^data-raw$
^.*\.Rproj$
^\.Rproj\.user$
```

### Verification Commands

```bash
# Check what Git is tracking
git ls-files

# Check what will be in the package
R CMD build . --no-build-vignettes
tar -tzf ForestSearch_*.tar.gz | head -50

# Verify data directory contents
R -e "tools::checkRdaFiles('data')"
```

## Resources

- [R Packages (2e) - Data](https://r-pkgs.org/data.html)
- [Writing R Extensions - Data in packages](https://cran.r-project.org/doc/manuals/R-exts.html#Data-in-packages)
- [CRAN Repository Policy](https://cran.r-project.org/web/packages/policies.html)
- [usethis Package](https://usethis.r-lib.org/)
- [GitHub - Managing repository access](https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/managing-repository-settings/managing-teams-and-people-with-access-to-your-repository)
