---
title: "Subgroup Identification Analysis"
subtitle: "GBSG Example"
author: "Larry Leon"
toc: true
number-sections: true
toc-depth: 3
format: 
  html:
    self-contained: true
    code-fold: true
    bibliography: references.bib
    fig_caption: yes
    keep_tex: yes
    latex_engine: xelatex
    citation_package: natbib
    fig_width: 10
    fig_height: 8
    fontsize: 10pt
    extra_dependencies: "subfig"
execute:
  warning: false
  message: false
  eval: true
---


```{r Setup, message=FALSE}
rm(list=ls())
# Record timing
# Start timer
t_start <- proc.time()

# Set options
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center',
  fig.retina = 2
)
library(tinytex)
library(ggplot2)
library(gt)

library(survival)
library(data.table)
library(randomForest)
library(grf)
library(policytree)
library(DiagrammeR)

# library(devtools)
# install_github("larry-leon/forestsearch", force = TRUE)

library(forestsearch)
library(weightedsurv)

# Set theme for plots
theme_set(theme_minimal(base_size = 12))
```


# Summary

Reproducing main GBSG analysis 

## Datasetup  
```{r Datasetup}
df.analysis <- gbsg
df.analysis <- within(df.analysis,{
id <- as.numeric(c(1:nrow(df.analysis)))  
# time to months
time_months <- rfstime/30.4375
grade3 <- ifelse(grade=="3",1,0)
treat <- hormon
})
confounders.name <- c("age","meno","size","grade3","nodes","pgr","er")
outcome.name <- c("time_months")
event.name <- c("status")
id.name <- c("id")
treat.name <- c("hormon")

```


## Kaplan-Meier curves and baseline summary

```{r, fig.width = 7, fig.height = 5}

dfcount <- df_counting(
  df = df.analysis,
  by.risk = 6,
  tte.name = outcome.name, 
  event.name = event.name, 
  treat.name = treat.name
)
plot_weighted_km(dfcount, conf.int = TRUE, show.logrank = TRUE, ymax = 1.05, xmed.fraction = 0.775, ymed.offset = 0.125)
```


```{r}
create_summary_table(data = df.analysis, treat_var = treat.name, 
                     table_title = "GBSG Characteristics by Treatment Arm",
                                      vars_continuous=c("age","nodes","size","er","pgr"),
                                      vars_categorical=c("grade","grade3"),
                                      font_size = 12)
```


## GRF analysis  
```{r GRF, echo=TRUE, eval=TRUE}
## GRF
grf_est1 <- grf.subg.harm.survival(data=df.analysis,
confounders.name = confounders.name,
outcome.name=outcome.name, event.name=event.name, id.name=id.name, treat.name=treat.name,
maxdepth = 2, n.min = 60, dmin.grf = 12, frac.tau=0.6, details=TRUE)
```

```{r, echo=TRUE, fig.width = 7, fig.height = 5}
# NOTE: In general for GRF trees
# leaf1 --> recommend control
# leaf2 --> recommend treatment
# Tree depth 1
plot(grf_est1$tree1,leaf.labels=c("Control","Treat"))
# Tree depth 2
plot(grf_est1$tree2,leaf.labels=c("Control","Treat"))
```




## Forestsearch with depth=2 (maxk = 2)

```{r, echo=TRUE, message=FALSE, warning=TRUE, fig.width = 10, fig.height = 8}

# Setup parallel processing
library(doFuture)
library(doRNG)

registerDoFuture()
registerDoRNG()

system.time({fs <- forestsearch(df.analysis,  confounders.name = confounders.name,
                                outcome.name = "time_months", treat.name = "hormon", event.name = "status", id.name = "id",
                                potentialOutcome.name = NULL, 
                                df.test = NULL,
                                flag_harm.name = NULL,
                                hr.threshold = 1.0, hr.consistency = 0.9, 
                                pconsistency.threshold = 0.90, stop_threshold = 0.95,
                                sg_focus = "hr", max_subgroups_search = 10, use_twostage = TRUE,
                                parallel_args = list(plan="multisession", workers = 13, show_message = TRUE),
                                showten_subgroups = TRUE, details=TRUE,
                                conf_force = NULL,
                                cut_type = "default", use_grf = TRUE, plot.grf = FALSE, use_lasso = FALSE,
                                maxk = 2, fs.splits = 100,
                                n.min = 60, d0.min = 12, d1.min = 12,
                                plot.sg = TRUE, by.risk = 6)
})

plan("sequential")

# Results for estimation (training) data, which_df = "est" is default
res_tabs <- sg_tables(fs, ndecimals = 3, which_df = "est")
res_tabs$sg10_out
res_tabs$tab_estimates

```


## Bootstrap Inference

```{r, eval = TRUE}

# patchhwork needed for a combined bootstrap plot (otherwise if not available or very few bootstraps do not produce)

library(patchwork)

# Number of bootstrap samples
NB <- 3
system.time({fs_bc <- forestsearch_bootstrap_dofuture(
  fs.est = fs, 
  nb_boots = NB, 
  show_three = FALSE, 
  details = TRUE)
})

plan("sequential")


```

### Diagnostics and Summaries

```{r, eval = TRUE}


summaries <- summarize_bootstrap_results(
      sgharm = fs$sg.harm,
      boot_results = fs_bc,
      create_plots = TRUE,
      est.scale = "hr"
    )

sg_tab <- summaries$table

sg_tab

event_summary <- summarize_bootstrap_events(fs_bc, threshold = 12)

summaries$diagnostics_table_gt

summaries$subgroup_summary$original_agreement

summaries$subgroup_summary$factor_presence

summaries$subgroup_summary$factor_presence_specific

```

```{r, fig.width = 5, fig.height = 8, eval = FALSE}
summaries$plots$H_distribution
summaries$plots$Hc_distribution
```


## Forest Search k-fold cross-validation  
```{r, echo=TRUE, eval = FALSE}
# 1 iteration of 2-fold cross-validation (in practice use 10-fold and at least 50 (Ksims) iterations)
Ksims <- 1
system.time({fs_ten <- forestsearch_tenfold(fs.est = fs, sims = Ksims, Kfolds = 2, details = FALSE, 
                       parallel_args = list(plan = "multisession", workers = 13, show_message = TRUE))})

plan(sequential)
print(fs_ten$find_summary)
print(fs_ten$sens_summary)
print(head(fs_ten$sens_out))
print(head(fs_ten$find_out))
```


## Forest Search OOB   
```{r, echo=TRUE, eval = FALSE}
# OOB = out-of-bag prediction
# Kfolds = n (default to n-fold cross-validations)
# Kfold = 2 for illustration

fs_OOB <- forestsearch_Kfold(fs.est = fs, details = TRUE, Kfolds = 2,
                             parallel_args = list(plan = "callr", workers = 13, show_message = TRUE))
# Reset workers to single
plan(sequential)
summary_OOB <- forestsearch_KfoldOut(res=fs_OOB, details=TRUE, outall=TRUE)
table(summary_OOB$SGs_found[,1])
table(summary_OOB$SGs_found[,2])
```


```{r, fig.width = 9, fig.height = 6}

# Define subgroups to display (these could be pre-specified or of post-hoc interest)
subgroups <- list(
 age_gt65 = list(
 subset_expr = "age > 65",
 name = "age > 65",
     type = "reference"
   ),
 age_lt65 = list(
 subset_expr = "age <= 65",
 name = "age <= 65",
     type = "reference"
   ),
pgr_positive = list(
 subset_expr = "pgr > 0",
 name = "pgr > 0",
     type = "reference"
   ),
pgr_negative = list(
 subset_expr = "pgr <= 0",
 name = "pgr <= 0",
     type = "reference"
   )
  )

# If fs_OOB and fs_kfold are provided then CV metrics are displayed for both

# Create the forest plot
 result <- plot_subgroup_results_forestplot(
   fs_results = list(fs.est = fs, fs_bc = fs_bc, fs_OOB = NULL, fs_kfold = NULL),
   df_analysis = df.analysis,
   subgroup_list = subgroups,
   outcome.name = "time_months",
   event.name = "status",
   treat.name = "hormon",
   E.name = "Hormon",
   C.name = "CT",
   ci_column_spaces = 25
 )

# Display the plot
plot(result$plot)

# Calculate elapsed time
t_elapsed <- (proc.time() - t_start)["elapsed"]
cat("Elapsed:", t_elapsed, "seconds\n")
```

