# ForestSearch Package — Independent Codebase Review

**Date:** February 9, 2026
**Scope:** Full codebase review from project knowledge base source files
**Standards:** CRAN compliance, tidyverse style, roxygen2 documentation

---

## Executive Summary

ForestSearch is a well-architected package with comprehensive documentation and a thoughtful modular design. The core algorithm, bootstrap bias correction, and cross-validation infrastructure are solid. However, several issues remain that would block or complicate CRAN submission, along with style and maintainability concerns that should be addressed.

**Verdict:** Close to CRAN-ready, but 3–4 critical items and ~10 high-priority items need resolution first.

---

## 1. CRITICAL — CRAN Blockers

### 1.1 Duplicate `globalVariables()` Declarations

**Files:** `R/globals.R`, `R/mrct_simulation.R`, `R/sim_aft_gbsg_refactored.R`, `R/forestsearch_cross-validation.R`

Multiple files contain their own `utils::globalVariables()` calls with overlapping variable names (e.g., `"sim"`, `"treat"`, `"event"`, `"Y"`, `"E"`, `"Treat"`). While R tolerates duplicate declarations, CRAN reviewers flag this as poor practice and it creates maintenance headaches.

**Recommendation:** Consolidate ALL `globalVariables()` into `R/globals.R` as the single source of truth. Remove all per-file declarations. The comment in `forestsearch-package.R` already says "All globalVariables() declarations are consolidated in globals.R" — make that actually true.

### 1.2 `ensure_packages()` References `install.packages()` in Error Message

**File:** `R/bootstrap_dofuture_setup_helpers.R`

```r
stop("Required package(s) not installed: ",
     paste(missing, collapse = ", "),
     "\nPlease install with: install.packages(c('",
     paste(missing, collapse = "', '"), "'))")
```

CRAN policy prohibits packages from suggesting users call `install.packages()`. While this is in a `stop()` message rather than executed code, CRAN reviewers have flagged this pattern. Change to:

```r
stop("Required package(s) not installed: ",
     paste(missing, collapse = ", "),
     call. = FALSE)
```

### 1.3 `set.seed()` Called Inside Exported Functions Without User Control

**Files:** `R/bootstrap_analysis_dofuture.R`, `R/bootstrap_calculations_helpers.R`

```r
# bootstrap_results() — exported function
set.seed(8316951)
```

```r
# bootstrap_ystar() — exported function
set.seed(8316951)
```

CRAN policy is strict: exported functions must not call `set.seed()` without user control. The comments say "do not modify seed it needs to align with ystar" — but this coupling is fragile and CRAN-unfriendly. The seed should be a parameter (already is `seedit` in `forestsearch()`) and passed through, or managed via `.Random.seed` preservation.

**Recommendation:** Add a `seed` parameter to both `bootstrap_results()` and `bootstrap_ystar()`, defaulting to `8316951`. Document the alignment requirement.

### 1.4 `BOOTSTRAP_REQUIRED_FUNCTIONS` List Contains Non-Existent / Internal Functions

**File:** `R/bootstrap_dofuture_setup_helpers.R`

The `BOOTSTRAP_REQUIRED_FUNCTIONS` list references functions like `"clean_data"`, `"prepare_data"`, `"run_grf"`, `"evaluate_subgroups"`, `"summarize_results"`, `"run_bootstrap"`, `"ci.est"`, `"count_boot_it"` — many of which don't appear to exist in the package namespace or have been renamed. This list is never actually used programmatically (the `get_bootstrap_exports()` function dynamically discovers exports), making it dead documentation that will confuse developers.

**Recommendation:** Either delete `BOOTSTRAP_REQUIRED_FUNCTIONS` entirely (since `get_bootstrap_exports()` is the actual mechanism), or audit and update every entry to match real function names.

---

## 2. HIGH — Correctness & Robustness

### 2.1 `bootstrap_results()` Uses Fragile Global Variable References in `foreach`

**File:** `R/bootstrap_analysis_dofuture.R`

The `.options.future` globals specification manually lists variables:

```r
.options.future = list(
  seed = TRUE,
  globals = structure(TRUE, add = c(
    get_bootstrap_exports(),
    "fs.est", "df_boot_analysis", "cox.formula.boot",
    "confounders_candidate",  # <-- Does this exist in scope?
    "H_obs", "Hc_obs", "nb_boots", "show_three",
    "args_foresearch_call",   # <-- TYPO: should be args_forestsearch_call
    "pconsistency.threshold",
    "pconsistency.digits",    # <-- Not defined in the parent scope
    "hr.consistency"
  ))
)
```

Issues found:
- **Typo:** `"args_foresearch_call"` should be `"args_forestsearch_call"` (missing 't')
- **Undefined variables:** `"confounders_candidate"`, `"pconsistency.digits"`, and `"hr.consistency"` don't appear to be defined in the `bootstrap_results()` scope — they're inside `fs.est$args_call_all`
- These may work by accident through R's scoping but will fail in strict parallel backends

**Recommendation:** Remove the manual globals list and rely on `globals = TRUE` (automatic detection), or carefully audit which variables are actually in scope.

### 2.2 `remove_redundant_subgroups()` Uses Fragile Row Differencing

**File:** `R/subgroup_consistency_helpers.R`

```r
temp2 <- as.matrix(found.new[, c("HR", "n", "E", "K", "L(HR)", "U(HR)")])
id_keep <- which(round(diff(temp2, lag = 1), 6) != 0)
```

This approach has multiple issues:
- `diff()` on a matrix computes element-wise differences, not row-wise
- The `which()` check `!= 0` on a matrix flattens it, losing row correspondence
- Column names with parentheses (`"L(HR)"`, `"U(HR)"`) are fragile

Compare with `remove_near_duplicate_subgroups()` which uses a proper key-based dedup — the redundant version should use a similar approach or be deprecated in favor of it.

### 2.3 `find_covariate_any_match()` Uses `charmatch()` for Prefix Matching

**File:** `R/forestsearch_cross-validation.R`

`charmatch()` does partial matching which can produce false positives (e.g., `"z1"` matching `"z11"`). The function already has a comment acknowledging this:

```r
# Handle case where multiple confounders match (e.g., "z1" and "z11")
```

But the workaround using `str_length` and `str_sub` is complex and brittle. Use exact matching with regex word boundaries or `startsWith()`/`endsWith()` instead.

### 2.4 `warnings(-1)` Suppression in Bootstrap

**File:** `R/bootstrap_dofuture_main.R`

```r
old_warn <- getOption("warn")
options(warn = -1)
```

Suppressing ALL warnings during the entire parallel bootstrap section is dangerous — it hides genuine problems (convergence failures, singular matrices, etc.). Use `suppressWarnings()` around specific known-noisy calls instead.

---

## 3. HIGH — Style & Tidyverse Compliance

### 3.1 Dot-Separated Parameter Names Throughout

The package uses dots extensively in parameter names: `df.analysis`, `sg.harm`, `hr.threshold`, `fs.splits`, `treat.name`, `by.risk`, etc. Tidyverse style requires snake_case (`df_analysis`, `sg_harm`, `hr_threshold`).

This is deeply embedded and changing it now would break backward compatibility. **Recommendation:** Document this as a known deviation. Consider adding snake_case aliases with deprecation warnings for a future major version.

### 3.2 Inconsistent Spacing and Formatting

Throughout the codebase:

```r
# Inconsistent spacing around operators
count_boot_id <- function(x,dfb){     # No spaces
  sum(dfb$id == x)                     # OK
}

calc_cov <- function(x,Est){           # No spaces, uppercase param
  mean(c((x-mean(x,na.rm=TRUE)) * Est),na.rm=TRUE)  # Dense
}
```

**Recommendation:** Run `styler::style_pkg()` across the entire package for consistent formatting.

### 3.3 Mixed Use of `return()` vs Implicit Return

Some functions use explicit `return()`, others rely on implicit last-expression return. Tidyverse style prefers implicit return for simple cases. Be consistent within each file at minimum.

### 3.4 Uppercase Variable Names in Function Parameters

Several functions use uppercase parameter names: `Est`, `Hobs`, `Treat`, `Y`, `Event`, `X`. Tidyverse convention is all-lowercase snake_case. While internal variables can be uppercase for mathematical notation clarity, exported function parameters should be lowercase.

---

## 4. MEDIUM — Documentation

### 4.1 S3 Method Consolidation Still Incomplete

**File header comment in `R/forestsearch_methods.R`:**
```
# After adopting this file:
#   1. Remove print.forestsearch() from R/forestsearch_main.R
#   2. Remove summary.forestsearch() from R/forestsearch_main.R
#   3. Remove plot.forestsearch() from R/forestsearch_helpers.R
```

This TODO suggests the consolidation hasn't been verified as complete. If duplicate definitions exist, R CMD check won't error but behavior becomes unpredictable depending on file load order.

**Recommendation:** Verify with `grep -r "print\.forestsearch\|summary\.forestsearch\|plot\.forestsearch" R/` that only `forestsearch_methods.R` contains these definitions. Remove the TODO comment once confirmed.

### 4.2 Missing `@return` Tags on Some Exported Functions

Several exported helper functions lack complete `@return` documentation:

- `dummy_encode()` / `dummy()` / `dummy2()` — `@return` is present but could be more specific about column naming conventions
- `one.zero()` — trivial but should document return type
- `ztrail()` — document that it's used internally for subgroup enumeration

### 4.3 `grf.subg.eval()` Has Stub Implementation

**File:** `R/grf_main.R`

```r
grf.subg.eval <- function(...) {
  # Implementation preserved from original
  # ... (rest of function)
  NULL
}
```

An exported function that returns `NULL` unconditionally will confuse users. Either implement it or mark as `@keywords internal` and remove `@export`.

### 4.4 Vignette Strategy Not Yet Implemented

The `_pkgdown.yml` references articles (`methodology.html`, `forestsearch.html`) that don't appear to exist yet. CRAN doesn't require vignettes but having at least one basic vignette dramatically improves reviewer reception.

---

## 5. MEDIUM — Architecture & Maintainability

### 5.1 `BOOTSTRAP_REQUIRED_FUNCTIONS` vs `get_bootstrap_exports()` Redundancy

Both mechanisms exist for discovering functions needed in parallel workers. `BOOTSTRAP_REQUIRED_FUNCTIONS` is a static, manually-maintained list organized by category. `get_bootstrap_exports()` dynamically discovers all exports. Only the dynamic version is actually called.

**Recommendation:** Keep `get_bootstrap_exports()` as the runtime mechanism. Convert `BOOTSTRAP_REQUIRED_FUNCTIONS` to documentation-only (a comment or internal help page) if the categorization is valuable, or delete it.

### 5.2 Deep Argument Pass-Through Pattern

The `forestsearch()` function captures all arguments via `mget()` into `args_call_all`, then uses `filter_call_args()` to dispatch subsets to downstream functions. While `filter_call_args()` is a clean helper, the pattern means:

- Adding a parameter to a downstream function requires checking if it flows through `args_call_all`
- Typos in parameter names silently disappear (filtered out)
- Debugging argument flow requires tracing through multiple `do.call()` chains

This is an inherent tension with the design. The current `filter_call_args()` approach is the best available solution, but document it clearly for future maintainers.

### 5.3 `on.exit()` Cleanup Could Be More Robust

**File:** `R/bootstrap_dofuture_main.R`

```r
on.exit({
  options(warn = old_warn)
  if (exists(".Last.future.plan")) {
    future::plan(.Last.future.plan)
  } else {
    future::plan("sequential")
  }
  ...
}, add = TRUE)
```

The variable `.Last.future.plan` is never defined in the visible scope. This block likely always falls through to `future::plan("sequential")`, which may not be the user's original plan. Capture the original plan at function entry:

```r
original_plan <- future::plan()
on.exit(future::plan(original_plan), add = TRUE)
```

---

## 6. LOW — Minor Issues

### 6.1 `ci.est` vs `ci_est` Naming

`BOOTSTRAP_REQUIRED_FUNCTIONS` references `"ci.est"` but the actual exported function is `ci_est()`. This is another indicator the static list is stale.

### 6.2 `format_CI()` Uses `..col_names` data.table Syntax

```r
resH <- estimates[, ..col_names]
```

This only works if `estimates` is a `data.table`. Add a defensive `as.data.table()` or document the requirement.

### 6.3 `get_dfRes()` Checks `exists("get_targetEst")`

```r
if (!exists("get_targetEst")) {
  stop("Function 'get_targetEst' must be defined in the environment.")
}
```

In a properly installed package, this should always be TRUE. This check is a leftover from script-based development. Remove it or replace with `requireNamespace()` check.

### 6.4 Comment References to Removed/Renamed Functions

Several files contain comments referencing functions by old names or contain TODO markers. A systematic grep for `TODO`, `FIXME`, `HACK`, `XXX` would surface these.

### 6.5 `plot.forestsearch()` Definition Location

The `forestsearch_helpers.R` header says it contains `plot.forestsearch()`, but `forestsearch_methods.R` is supposed to be the canonical location. Verify there's only one definition.

---

## 7. Positive Observations

Several aspects of the codebase deserve recognition:

1. **Excellent roxygen2 documentation** — The `forestsearch()` main function and `plot_subgroup_results_forestplot()` have thorough, well-structured documentation with parameter descriptions, return values, details sections, and examples.

2. **Clean `filter_call_args()` pattern** — This utility elegantly solves the argument-dispatch problem and is used consistently throughout.

3. **Robust error handling** — `tryCatch()` blocks around GRF, LASSO, and subgroup search prevent cascading failures. The bootstrap handles low-event scenarios gracefully with informative messages.

4. **Well-designed S3 class system** — The `forestsearch`, `fs_kfold`, `fs_tenfold`, `fs_forestplot`, `fs_forest_theme` classes with proper print/summary/plot methods show mature package design.

5. **Comprehensive `_pkgdown.yml`** — The function reference is thoughtfully organized into 15+ functional categories, making the package navigable.

6. **Two-stage consistency algorithm** — The `use_twostage` option with backward compatibility is well-designed, with clear documentation of when to use each approach.

7. **Bootstrap bias correction methodology** — The implementation of León et al. (2024) methods with both simple optimism and double-bootstrap corrections, plus infinitesimal jackknife variance estimation, is methodologically rigorous.

8. **Cross-validation infrastructure** — The K-fold CV with agreement metrics (sensitivity, PPV, covariate-level matching) goes well beyond typical CV implementations and provides clinically meaningful validation.

---

## Summary Priority Table

| Priority | Count | Category |
|----------|-------|----------|
| CRITICAL | 4 | CRAN blockers (globalVariables, install.packages, set.seed, dead code) |
| HIGH | 7 | Correctness (typo in globals, fragile dedup, warning suppression) + Style |
| MEDIUM | 5 | Documentation gaps, architecture notes |
| LOW | 5 | Minor naming, defensive checks, stale comments |

**Recommended action order:**
1. Fix the 4 CRITICAL items (< 1 day)
2. Address HIGH correctness issues 2.1–2.4 (1–2 days)
3. Run `styler::style_pkg()` for formatting consistency
4. Verify S3 method consolidation is complete
5. Create at minimum one introductory vignette
6. Run `R CMD check --as-cran` and address any remaining NOTEs
