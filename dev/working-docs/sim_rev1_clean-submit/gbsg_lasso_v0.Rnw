\Sexpr{set_parent("forestSearch_SIM-Rev1_v0.Rnw")}


<<echo=FALSE>>=
opts_chunk$set (warning = FALSE, message = FALSE, tidy=TRUE, echo=FALSE, dev = 'pdf')
options(warn=-1)
@
  
<<echo=FALSE>>=
rm(list=ls())
# For KM plots
codepath<-c("../../R/")
source(paste0(codepath,"source_forestsearch_v0.R"))
source_fs_functions(file_loc=codepath)

library(survival)

gbsg_cens<-round(1-mean(gbsg$status),2)

load(file="../applications/gbsg/output/gbsg_lasso_v0.Rdata")
# Analysis dataset
df <- fs.est$df.est

df0.fs<-subset(fs.est$df.pred,treat.recommend==0)
df1.fs<-subset(fs.est$df.pred,treat.recommend==1)
# ITT analysis
cox_itt<-summary(coxph(Surv(time_months,status)~hormon,data=fs.est$df.pred))$conf.int
# ITT estimates
resITT<-c(round(cox_itt[c(1,3,4)],2),nrow(fs.est$df.pred))
@
  
  
<<echo=FALSE,message=FALSE,warning=FALSE>>=
H_estimates <- round(fs_bc$H_estimates,2)
Hc_estimates <- round(fs_bc$Hc_estimates,2)
resH <- unlist(H_estimates[,c("H0","H0_lower","H0_upper")])
resHB <- unlist(H_estimates[,c("H2","H2_lower","H2_upper")])
resHc <- unlist(Hc_estimates[,c("H0","H0_lower","H0_upper")])
resHcB <- unlist(Hc_estimates[,c("H2","H2_lower","H2_upper")])

L_factors <- fs.est$find.grps$L
max_count <- fs.est$find.grps$max_count
sg_loc <- fs.est$grp.consistency$sg.harm.id
SG_hrs <- fs.est$grp.consistency$out_hr$result
p_consistency <- 100*round(SG_hrs$Pcons[sg_loc],3)

H_nfold <- summary_OOB$SG_tab_Kfold$res_out[1,8]
Hc_nfold <- summary_OOB$SG_tab_Kfold$res_out[2,8]

# N-fold SGs
SG_tab_Kfold <- summary_OOB$SG_tab_Kfold$res_out
nH_OOB <- SG_tab_Kfold[1,c("n")]
# Full analysis
SG_tab_full <- summary_OOB$SG_tab_original$res_out
nH_full <- SG_tab_full[1,c("n")]

H_nfold <- summary_OOB$SG_tab_Kfold$res_out[1,8]
Hc_nfold <- summary_OOB$SG_tab_Kfold$res_out[2,8]

# Number of SGs found in N-fold
nf_OOB <- round(fs_OOB$prop_SG_found*nrow(df)/100,0)
# Proportion found
pf_OOB <- fs_OOB$prop_SG_found

#summary(fs_ten$find_out[,"Any"])

@
  
  
  
<<echo=FALSE,eval=FALSE>>=
# Output as PDF for more 
# control on formatting
#pdf(file = "Figure 3.pdf",   
#width = 10, height = 10) 

library(latex2exp)

par(mfrow=c(1,2))
tte.name<-c("time_months")
event.name<-c("status")
treat.name<-c("hormon")
byrisk <- 12

risk.cex<-0.95
legend.cex<-0.90

df.analysis <- fs.est$df.pred
# Add all events
evs<-sort(unique(df.analysis$time_months[which(df.analysis$status==1)]))
tpoints.add<-c(-1,evs,max(df.analysis$time_months))

# Legend labels for H

Hla<-sprintf(r'($\hat{H}, %s$)',c("Treatment"))
Hlb<-sprintf(r'($\hat{H}, %s$)',c("Control"))
Hl<-c(Hla,Hlb)

hr.ci <- hrCI_format(resHB)
Hhr_show <- paste0("${\\widehat{\\theta}^{*}} =$",hr.ci)


Hcla<-sprintf(r'($\hat{H^{c}}, %s$)',c("Treatment"))
Hclb<-sprintf(r'($\hat{H^{c}}, %s$)',c("Control"))
Hcl<-c(Hcla,Hclb)

hr.ci <- hrCI_format(resHcB)
Hchr_show <- paste0("${\\widehat{\\theta}^{*}} =$",hr.ci)

dfp<-df0.fs

kmH.fit<-KM.plot.2sample.weighted(Y=dfp[,c(tte.name)],E=dfp[,c(event.name)],Treat=dfp[,c(treat.name)],
                                  risk.set=TRUE,by.risk=byrisk,tpoints.add=tpoints.add,risk.cex=risk.cex,
                                  stop.onerror=TRUE,check.KM=TRUE,
                                  Xlab="Months",Ylab="Recurrence-free Survival",details=FALSE,
                                  show.ticks=TRUE,
                                  col.1="black", col.2="blue",
                                  ltys=c(1,2),lwds=c(3,3),
                                  plotit=TRUE, risk_offset=0.125, risk_delta=0.05,
                                  show.logrank=FALSE,show.med=FALSE,show.cox=FALSE)
title(sub="(a) Estrogen = 0")

legend("topright",
       legend=TeX(Hl),col=c("black","blue"),lwd=c(3,3),lty=c(1,2),bty="n",cex=legend.cex)

text(70, 0.80, TeX(Hhr_show))

dfp<-df1.fs

kmH.fit<-KM.plot.2sample.weighted(Y=dfp[,c(tte.name)],E=dfp[,c(event.name)],Treat=dfp[,c(treat.name)],
                                  risk.set=TRUE,by.risk=byrisk,tpoints.add=tpoints.add,risk.cex=risk.cex,
                                  show.Y.axis=FALSE,
                                  stop.onerror=TRUE, check.KM=TRUE,
                                  Xlab="Months",Ylab="",details=FALSE,
                                  show.ticks=TRUE,
                                  col.1="black", col.2="blue",
                                  ltys=c(1,2),lwds=c(3,3),
                                  plotit=TRUE, risk_offset=0.125, risk_delta=0.05,
                                  show.logrank=FALSE,show.med=FALSE,show.cox=FALSE)
title(sub="(b) Estrogen > 0")

legend("topright",
       legend=TeX(Hcl),col=c("black","blue"),lwd=c(3,3),lty=c(1,2),bty="n",cex=legend.cex)

text(70, 0.80, TeX(Hchr_show))

#dev.off()
@

\begin{figure}
\begin{center}
\includegraphics[width=\textwidth, height=3.25in]{Figure 3.eps}
\end{center}
\caption{GBSG analysis application of Forest Search. Kaplan-Meier (K-M) curves (un-adjusted for the estimation of subgroups) with bootstrap-bias corrected 
Cox estimates and $95\%$ confidence intervals denoted $\hat\theta^{*}$: (a) Forest Search $\widehat{H}$ subgroup; (b) Forest Search $\widehat{H}^{c}$ subgroup.}
\label{fig:gbsg}
\end{figure}


\subsection{GBSG analysis}

In our first application we return to the breast cancer study\cite{Schumacher_1994,Sauerbrei_1999} described in Section \ref{sec:sims}.  Recall the study sample size was $N=\Sexpr{nrow(gbsg)}$ where 
we consider the comparison of tamoxifen (hormonal) treatment to chemotherapy.  The observed censoring rate was $\approx \Sexpr{100*gbsg_cens}\%$, and the Cox ITT hazard ratio estimate ($95\%$ CI) was $\Sexpr{resITT[1]}$ ($\Sexpr{resITT[2]}$, $\Sexpr{resITT[3]}$). There were $p=7$ prognostic factors collected: \verb+Estrogen+, \verb+Age+, \verb+Prog+, \verb+Meno+, \verb+Nodes+, \verb+Size+, and \verb+Grade+.   The factors \verb+Meno+ and \verb+Grade+ (grade 1/2 vs 3) are categorical and the rest are continuous. 

In this analysis we select the largest subgroup with a consistency rate of at least $90\%$ where lasso\cite{SFHT_2011} is first applied with the aforementioned factors, and for the continuous factors (selected per lasso), these are cut at the mean, median, 1st quartile, and 3rd quartile.  We note that an alternative analysis where lasso is not applied yields the same estimated subgroups and virtually identical bootstrap bias-corrected estimates (described below).  In addition, another alternative analysis maximizing the consistency rate is described in Supplementary materials \textcolor{blue}{S2.1}.  In comparison to these alternative analyses, the 10-fold CV properties for the current analysis suggests preferable algorithmic stability (details described below).  

Now, the first stage of our algorithm is to apply lasso which selects \verb+Grade+, \verb+Size+,  \verb+Nodes+, and \verb+Prog+, the last 
three of which are continuous, and binary cuts at the mean, median, 1st quartile, and 3rd quartile were included for each continuous factor. Next, applying GRF ($\grfb$ with a 6-month RMST criterion) selects \verb+Estrogen<=0+ (Estrogen cut at $0$).  There were then $K=14$ candidate factors (binary cuts) and thus $L = \Sexpr{L_factors}$ total single factor subgroups with $L(L-1)/2+L = \Sexpr{max_count}$ possible subgroups (two-factor combinations); among these subgroups the number of candidates with sample sizes $\geq 60$ and at least $10$ events in each arm was reduced to $263$. 

The FS approach estimates $\widehat{H}$ as the subgroup \verb+Estrogen<=0+ (The consistency rate is $\Sexpr{p_consistency}\%$).  That is, $\widehat{H}$ subjects are those with an estrogen level of $0$ and the resulting $\hat{H}$-estimates were $\hhat = \Sexpr{resH[1]}$ ($\Sexpr{resH[2]}$, $\Sexpr{resH[3]}$) with bootstrap bias-corrected $\hhatB =\Sexpr{resHB[1]}$ ($\Sexpr{resHB[2]}$, $\Sexpr{resHB[3]}$).  For the complement, $\hchat = \Sexpr{resHc[1]}$ ($\Sexpr{resHc[2]}$, $\Sexpr{resHc[3]}$) and $\hchatB =\Sexpr{resHcB[1]}$ ($\Sexpr{resHcB[2]}$, $\Sexpr{resHcB[3]}$).  The bias-corrected estimate for $H^{c}$ suggests a slightly stronger benefit ($\Sexpr{resHcB[1]}$ vs $\Sexpr{resITT[1]}$ for ITT) that is statistically significant and corresponds to $604/686 \approx \Sexpr{100*round((1-nrow(df0.fs)/nrow(gbsg)),2)}\%$ of the ITT population.   Whereas for $H$, the bias-corrected estimate is not statistically significant for detriment but may suggest careful consideration for subjects without positive estrogen levels. Figure \ref{fig:gbsg} displays the Kaplan-Meier curves for the estimated subgroups.

For $N$-fold CV, across the $N=\Sexpr{nrow(df)}$ training sets (based on deleting a single subject) 
all analyses identified \verb+Estrogen<=0+.  Therefore, the $N$-fold $\hat\pi^{-i}(\cdot)$ and observed (un-adjusted) 
$\hat\pi(\cdot)$ are identical (i.e., no actual adjustment via $N$-fold CV).  In contrast, across the $200$ random 10-fold CV analyses the median number of training sets (10 folds) with an identified subgroup was 9 out of 10 (The minimum was 5/10 with lower and upper quartiles of 8/10 and 9/10, resp.) resulting in a sensitivity of $sensCV(\widehat{H}) = 73\%$.  That is, among the $\widehat{H}$-classified subjects based on the full analysis the median percentage also $\widehat{H}$-classified in the (10-fold) CV testing samples was approximately $73\%$. The median positive predictive value was $ppvCV(\widehat{H}) \approx 83\%$. For the complement $\widehat{H}^{c}$, the medians for $sensCV$ and $ppvCV$ were $98\%$ and $96\%$, respectively.  In addition, across the $200$ random 10-fold CV analyses, the exact full analysis definition ($\hat{H}$ subgroup) of \verb+Estrogen<=0+ was reproduced $70\%$ of the time (median).  Note that these summaries are reflective of the (median) 9 out of 10 training samples identifying a subgroup $\widehat{H}$ (Recall, if FS does not identify a subgroup then $\widehat{H}=\emptyset$, $\widehat{H}^{c}$ represents the ITT population, and the CV metrics are defined accordingly.).

We note that the GRF approach itself also identified \verb+Estrogen<=0+.  In addition, when the current FS selection criteria is modified by not including lasso in the algorithm, the FS approach also identified \verb+Estrogen<=0+ with virtually identical $\hhatB$ and $\hchatB$ estimates. However the 10-fold CV properties do not compare favorably to the current FS analysis.  Specifically, across the 10-fold CV analyses a subgroup was identified (median) 8 out of 10 times with a sensitivity of $sensCV(\widehat{H}) = 55\%$.  The positive predictive value was $ppvCV(\widehat{H}) \approx 67\%$, and for the complement, the medians for the corresponding $sensCV$ and $ppvCV$ were $96\%$ and $94\%$, respectively (The exact $\hat{H}$ subgroup definition of \verb+Estrogen<=0+ was reproduced (median) $40\%$ of the time.).  Moreover an additional FS analysis, maximizing consistency, estimates $\widehat{H}$ as the subgroup formed by the combination of \verb+Estrogen<=0+ and \verb+Prog<=32.5+, which in comparison to the aforementioned FS algorithms exhibits less favorable CV properties (details in Supplementary materials \textcolor{blue}{S2.1}).  

The computational timing for the current analysis on an Apple studio (M1 20 core with 69 GB) was approximately: $0.05$ minutes for the FS analysis; $29$ minutes for the $2000$ bootstraps; $\Sexpr{round(fs_OOB$timing_minutes,0)}$ minutes for the $N$-fold CV; and $\Sexpr{round(tall.min-32.61,0)}$ minutes for the $200$ random 10-fold CV analyses.  In total, the number of minutes was $\approx \Sexpr{round(tall.min,0)}$.  


Regarding the plausibility of the subgroup analysis results suggesting subjects without positive estrogen levels may not benefit from tamoxifen treatment compared to chemotherapy.   We note that tamoxifen is a selective estrogen receptor (ER) 
modulator and is mainly indicated (as of the 2016 era) for the treatment of breast cancer in postmenopausal women and postsurgery neoadjuvant therapy in ER-positive breast cancers.\cite{Manna_2016}  ER-negative tumors are characterized by the lack of (or very small levels of) ER expression\cite{Manna_2016} with 2010 guidelines suggesting tumors with $\geq 1\%$ expression of ER to be considered ER positive.\cite{Yu_2021}  In a meta-analysis of five randomized prevention trials, 
Cuzick et al\cite{Cuzick_2003} report that, in the tamoxifen prevention trials, there was no effect for breast cancers that were negative for estrogen receptor (hazard ratio 1.22 [0.89-1.67]). More recently, in a patient-level meta-analysis of randomized trials conducted by the Early Breast Cancer Trialists' Collaborative Group, for `estrogen negative' (ER=0) subjects, there were over 5,000 woman-years of follow-up in each of the tamoxifen and control arms with similar events (162 events for tamoxifen and 163 for control) corresponding to an estimated event-rate ratio of 1.11 (SE=0.13); whereas for `estrogen positive' (ER $\geq 10\%$) subjects the event-rate ratio was 0.62 (SE=0.03).\cite{Davies_2011}  Lastly, in Supplementary materials \textcolor{blue}{S3} we applied the identified subgroup definitions (ER=0, ER>0, say) to the Rotterdam tumor bank data \citep{Foekens_2000} which was utilized for ``external validation 
of a Cox prognostic model''. \citep{Royston_2013}  Briefly, the Rotterdam data was observational and we implemented (stabilized) propensity-score weighting.\cite{Cole_2004}  The Cox model estimates were $0.55$ $(0.30, 1.01)$ for subjects without estrogen levels (ER=0) and 
$0.65$ $(0.49, 0.86)$ for subjects with positive estrogen levels (ER>0).  In contrast to our results, estimates for subjects without estrogen levels trended towards a favorable benefit; whereas estimates for subjects with positive estrogen levels were fairly 
consistent compared to $\hchatB =\Sexpr{resHcB[1]}$ ($\Sexpr{resHcB[2]}$, $\Sexpr{resHcB[3]}$).   




  