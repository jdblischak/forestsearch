---
title: "AFT-DGM Examples: Summary of Key Concepts"
format: 
  html:
    toc: true
    toc-depth: 3
    code-fold: false
    theme: cosmo
---

# Overview

This document summarizes a comprehensive simulation study for **subgroup identification in clinical trial analysis** using the German Breast Cancer Study Group (GBSG) dataset. The methodology demonstrates how to generate realistic synthetic clinical trial data with calibrated treatment-subgroup interactions and validate findings through bootstrap inference.

## Core Components

1. **AFT Data Generating Mechanism (DGM)** - Flexible simulation framework
2. **Quantile-based subgroup definition** - Clinical characteristic-based patient stratification
3. **Calibrated interaction effects** - Achieving target hazard ratios
4. **Forest search methodology** - Systematic subgroup identification
5. **Bootstrap inference** - Bias correction and uncertainty quantification

---

# 1. AFT Data Generating Mechanism

## Model Specification

The Accelerated Failure Time (AFT) model with Weibull distribution:

$$\log(T) = \mu + \gamma' X + \sigma \epsilon$$

where:

- $T$ is the survival time
- $\mu$ is the intercept
- $\gamma$ contains covariate effects (including treatment and interaction)
- $X$ includes covariates and treatment×subgroup interaction
- $\sigma$ is the scale parameter
- $\epsilon$ follows an extreme value distribution

## Key Parameters

| Parameter | Description | Role |
|-----------|-------------|------|
| `k_treat` | Treatment effect modifier | Scales main treatment effect |
| `k_inter` | Interaction effect modifier | Controls differential treatment effects |
| `n_super` | Super-population size | Base population for sampling |
| `sigma` | Scale parameter | Controls distribution shape |

## Advantages of AFT-DGM

::: {.callout-note}
## Why AFT Models?

- **Interpretability**: Effects are on survival time scale
- **Flexibility**: Can generate complex treatment-subgroup interactions
- **Calibration**: Parameters can be tuned to achieve specific target effects
- **Realism**: Mimics real clinical trial data distributions
:::

---

# 2. Subgroup Definition Strategy

## GBSG Dataset Context

The German Breast Cancer Study Group dataset contains:

- **N = 686** patients
- **Variables**: Age, menopausal status, tumor characteristics, hormone receptors, survival outcomes
- **Outcome**: Recurrence-free survival time (days)
- **Treatment**: Hormonal therapy (yes/no)

## Subgroup Specification

The study defines a **harm subgroup** based on two clinical characteristics:

```{r}
#| eval: false

# Calculate ER quantile cutpoint (approximately 25th percentile)
er_quantile <- 0.2612616
er_cutpoint <- quantile(gbsg$er, probs = er_quantile)

# Create subgroup indicator
gbsg$subgroup <- with(gbsg, 
                      (er <= er_cutpoint) & (meno == 0))
```

### Subgroup Characteristics

| Criterion | N | Proportion |
|-----------|---|------------|
| ER ≤ 25th percentile | 179 | 26.1% |
| Pre-menopausal | 290 | 42.3% |
| **Both conditions** | **84** | **12.2%** |

::: {.callout-tip}
## Clinical Interpretation

This subgroup represents **young, pre-menopausal women with low estrogen receptor levels** - a clinically meaningful population that may respond differently to hormonal therapy.
:::

---

# 3. Calibrating Interaction Effects

## Finding k_inter for Target Hazard Ratio

A key innovation is the ability to **calibrate** the interaction parameter to achieve specific hazard ratios in the harm subgroup.

### Calibration Process

```{r}
#| eval: false

# Find k_inter for HR_harm = 2.0
result <- forestsearch::find_k_inter_for_target_hr(
  target_hr_harm = 2.0,
  data = gbsg,
  outcome_var = "rfstime",
  event_var = "status",
  treatment_var = "hormon",
  continuous_vars = c("age", "er", "pgr"),
  factor_vars = c("meno", "grade"),
  subgroup_vars = c("er", "meno"),
  subgroup_cuts = list(
    er = list(type = "quantile", value = er_quantile),
    meno = 0
  ),
  k_treat = 1.0,
  verbose = FALSE
)
```

### Calibration Results

| Target HR | Optimal k_inter | Achieved HR | Error |
|-----------|-----------------|-------------|-------|
| 2.0 | 1.3009 | 2.0002 | 0.000162 |

::: {.callout-important}
## Why Calibration Matters

Calibration ensures the simulated data has **realistic and controlled effect sizes**, making simulation studies more credible and allowing researchers to test subgroup identification methods under known ground truth conditions.
:::

---

# 4. Sensitivity Analysis

## Impact of k_inter on Hazard Ratios

The sensitivity analysis examines how the interaction parameter affects treatment effects across three populations:

```{r}
#| eval: false

# Run sensitivity analysis
sensitivity_results <- sensitivity_analysis_k_inter(
  data = df_gbsg,
  k_inter_range = c(-1.5, 1.5),
  n_points = 11,
  model = "alt",
  continuous_vars = c("age", "size", "nodes", "pgr", "er"),
  factor_vars = c("meno", "grade"),
  outcome_var = "tte",
  event_var = "status",
  treatment_var = "hormon",
  subgroup_vars = c("er", "meno"),
  subgroup_cuts = list(
    er = list(type = "quantile", value = er_quantile),
    meno = 0
  ),
  k_treat = 1.0,
  n_super = 5000
)
```

## Key Insights

- **k_inter < 0**: Treatment more beneficial in harm subgroup
- **k_inter = 0**: No differential treatment effect (null scenario)
- **k_inter > 0**: Treatment less beneficial (or harmful) in harm subgroup
- **k_inter ≈ 1.3**: Harm subgroup HR = 2.0 (treatment detrimental)

::: {.callout-note}
## Three Populations Tracked

1. **Harm Subgroup**: Young, low-ER, pre-menopausal women
2. **No-Harm Subgroup**: Remaining patients
3. **Overall Population**: All patients combined
:::

---

# 5. Forest Search Methodology

## Algorithm Overview

The **ForestSearch** algorithm systematically identifies subgroups with differential treatment effects using a multi-stage approach.

### Stage 1: Generalized Random Forests (GRF)

```{r}
#| eval: false

# GRF identifies initial candidate splits
use_grf = TRUE
plot.grf = TRUE
```

**Purpose**: Identify promising covariate splits for subgroup definition

**Output**: Initial candidate cutpoints (e.g., "size ≤ 25", "nodes ≤ 5")

### Stage 2: Cox-LASSO Variable Selection

```{r}
#| eval: false

use_lasso = TRUE
```

**Purpose**: Select relevant prognostic variables

**Example Output**:
- Selected: `z_er`, `z_pgr`, `z_meno`, `z_grade_1`, `size`
- Not selected: `z_age`, `z_grade_2`, `nodes`

### Stage 3: Combinatorial Search

**Parameters**:

```{r}
#| eval: false

maxk = 2              # Maximum factors defining subgroup
n.min = 60            # Minimum subgroup size
d0.min = 12           # Minimum events in control arm
d1.min = 12           # Minimum events in treatment arm
hr.threshold = 1.25   # Minimum HR for "harm"
```

**Process**:
1. Generate all possible factor combinations (≤ maxk)
2. Evaluate each combination for:
   - Sample size requirements
   - Event count requirements
   - Hazard ratio threshold
3. Rank candidates by HR magnitude

### Stage 4: Consistency Validation

```{r}
#| eval: false

hr.consistency = 1.0
pconsistency.threshold = 0.90
```

**Purpose**: Ensure subgroup is stable across random data splits

**Method**: 
- Split data 1000 times
- Check if subgroup definition holds in each split
- Require ≥90% consistency

---

# 6. Bootstrap Inference & Bias Correction

## Bootstrap Procedure

```{r}
#| eval: false

# Run bootstrap with 1000 iterations
fs_bc <- forestsearch_bootstrap_dofuture(
  fs.est = fs,
  nb_boots = 1000,
  show_three = FALSE,
  details = TRUE
)

# Summarize results with bias correction
summaries <- summarize_bootstrap_results(
  sgharm = fs$sg.harm,
  boot_results = fs_bc,
  create_plots = TRUE,
  est.scale = "hr"
)
```

## Bootstrap Success Metrics

| Metric | Value | Assessment |
|--------|-------|------------|
| Total iterations | 1000 | — |
| Successful subgroup ID | 954 (95.4%) | ✓✓✓ Excellent |
| Failed to find subgroup | 46 (4.6%) | — |
| Average time per iteration | 19.5 seconds | — |

## Bias Correction Results

### Harm Subgroup (Questionable)

| Estimate Type | Hazard Ratio (95% CI) | Bias Correction Impact |
|---------------|----------------------|------------------------|
| Unadjusted | 1.92 (1.17, 3.16) | — |
| **Bias-corrected** | **1.55 (0.84, 2.85)** | **19.2%** |

### Recommend Subgroup

| Estimate Type | Hazard Ratio (95% CI) | Bias Correction Impact |
|---------------|----------------------|------------------------|
| Unadjusted | 0.70 (0.54, 0.90) | — |
| **Bias-corrected** | **0.72 (0.49, 1.06)** | **3.0%** |

::: {.callout-warning}
## Interpreting Bias Correction

The **19.2% bias correction** in the harm subgroup indicates substantial **optimism** in the unadjusted estimate. This is expected when selecting subgroups that maximize observed treatment differences - the bootstrap corrects for this selection bias.
:::

## Factor Stability Analysis

Frequency of factors appearing across bootstrap samples:

| Rank | Factor | Count | Percent |
|------|--------|-------|---------|
| 1 | z_er | 528 | 55.3% |
| 2 | z_age | 434 | 45.5% |
| 3 | nodes | 291 | 30.5% |
| 4 | size | 192 | 20.1% |
| 5 | z_pgr | 185 | 19.4% |
| 6 | z_meno | 118 | 12.4% |

::: {.callout-tip}
## Factor Importance

Estrogen receptor (z_er) and age (z_age) are the most **stable** factors, appearing in >45% of bootstrap samples. This suggests these are **robust predictors** of differential treatment effects.
:::

---

# 7. Key Findings from Simulation

## Null Scenario (No Interaction)

**Setup**: `k_inter = 0.0` (no treatment-subgroup interaction)

**Results**:
- Treatment effect is consistent across all subgroups
- No differential benefit or harm
- Kaplan-Meier curves show parallel separation

## Alternative Scenario (With Interaction)

**Setup**: `k_inter = 1.3009` (calibrated for HR = 2.0 in harm subgroup)

### Identified Subgroup

**Definition**: `{z_age ≤ 53} & {z_er ≤ 9}`

- **Size**: 108 patients (15.4%)
- **Events**: 61 events (56.5% event rate)

### Treatment Effects

**Harm Subgroup**:
- Median survival: 36.4 (treatment) vs 46.5 (control) months
- RMST difference: -8.5 months (treatment worse)
- HR: 1.92 (1.17, 3.16) unadjusted, 1.55 (0.84, 2.85) bias-corrected
- **Interpretation**: Treatment appears harmful in this subgroup

**Recommend Subgroup** (remaining 84.6%):
- Median survival: 76.7 (treatment) vs 53.5 (control) months  
- RMST difference: +8.1 months (treatment better)
- HR: 0.70 (0.54, 0.90) unadjusted, 0.72 (0.49, 1.06) bias-corrected
- **Interpretation**: Treatment is beneficial in this subgroup

::: {.callout-important}
## Clinical Implications

This demonstrates **treatment effect heterogeneity**: hormonal therapy works well for most patients (HR = 0.70) but may be detrimental for young, pre-menopausal women with low estrogen receptors (HR = 1.92).
:::

---

# 8. Practical Workflow

## Step-by-Step Process

### Step 1: Define Subgroup Characteristics

```{r}
#| eval: false

subgroup_vars <- c("er", "meno")
subgroup_cuts <- list(
  er = list(type = "quantile", value = 0.25),
  meno = 0
)
```

### Step 2: Calibrate DGM

```{r}
#| eval: false

# Find k_inter for target HR
result <- find_k_inter_for_target_hr(
  target_hr_harm = 2.0,
  data = gbsg,
  # ... other parameters
)
```

### Step 3: Generate DGM

```{r}
#| eval: false

dgm_alt <- generate_aft_dgm_flex(
  data = df_gbsg,
  n_super = 5000,
  k_inter = result$k_inter,
  # ... other parameters
)
```

### Step 4: Simulate Data

```{r}
#| eval: false

draw_alt <- simulate_from_dgm(
  dgm = dgm_alt,
  n = 700,
  rand_ratio = 1,
  seed = 123
)
```

### Step 5: Run Forest Search

```{r}
#| eval: false

fs <- forestsearch(
  df_alt,
  confounders.name = c("z_age", "z_er", "z_pgr", ...),
  maxk = 2,
  hr.threshold = 1.25,
  pconsistency.threshold = 0.90,
  # ... other parameters
)
```

### Step 6: Bootstrap Validation

```{r}
#| eval: false

fs_bc <- forestsearch_bootstrap_dofuture(
  fs.est = fs,
  nb_boots = 1000
)

summaries <- summarize_bootstrap_results(
  sgharm = fs$sg.harm,
  boot_results = fs_bc
)
```

---

# 9. Applications & Use Cases

## Research Applications

::: {.panel-tabset}

## Clinical Trials

- **Phase III trial analysis**: Identify patient subgroups with differential treatment effects
- **Post-hoc subgroup analysis**: Explore heterogeneity in treatment response
- **Adaptive trials**: Use subgroup findings to modify treatment assignment

## Precision Medicine

- **Biomarker development**: Identify predictive biomarkers for treatment selection
- **Treatment recommendation systems**: Personalized treatment decisions
- **Risk stratification**: Identify high-risk patients who need alternative therapies

## Regulatory Submissions

- **Subgroup claims**: Justify subgroup-specific treatment recommendations
- **Sensitivity analyses**: Demonstrate robustness of findings
- **Meta-analyses**: Synthesize subgroup effects across studies

## Methods Research

- **Simulation studies**: Evaluate subgroup identification methods under known truth
- **Power calculations**: Determine sample sizes for detecting interactions
- **Method comparison**: Compare different subgroup identification approaches

:::

---

# 10. Best Practices & Recommendations

## Design Considerations

### Sample Size

::: {.callout-tip}
## Minimum Requirements

- **Overall sample size**: ≥500 for reliable subgroup identification
- **Subgroup size**: ≥60 patients per subgroup (configurable via `n.min`)
- **Events**: ≥12 events per arm per subgroup (configurable via `d0.min`, `d1.min`)
:::

### Effect Size

- **Target HR ≥ 1.5** for meaningful clinical impact
- **HR threshold ≥ 1.25** for subgroup identification (`hr.threshold`)
- Consider clinically relevant effect sizes, not just statistical significance

### Consistency

- **Consistency threshold ≥ 0.90** ensures stability (`pconsistency.threshold`)
- Higher thresholds (0.95) for more stringent validation
- Lower thresholds (0.80) for exploratory analysis

## Analysis Recommendations

### Bootstrap Inference

```{r}
#| eval: false

# Recommended settings
nb_boots = 1000  # Minimum for stable estimates
nb_boots = 2000  # Better for CI precision
```

- Use **≥1000 bootstrap iterations** for reliable bias correction
- Monitor bootstrap success rate (aim for ≥90%)
- Check factor stability across bootstrap samples

### Parallel Processing

```{r}
#| eval: false

# Efficient parallel setup
library(doFuture)
plan("multisession", workers = 8)  # Adjust based on cores

parallel_args = list(
  plan = "callr", 
  workers = 12, 
  show_message = TRUE
)
```

### Variable Selection

- Use **LASSO** for prognostic variable selection (`use_lasso = TRUE`)
- Use **GRF** for initial cutpoint discovery (`use_grf = TRUE`)
- Force inclusion of key clinical variables via `conf_force`

## Reporting Standards

### Essential Elements

1. **Subgroup definition**: Clear specification of inclusion criteria
2. **Sample characteristics**: Size, event rates, baseline covariates
3. **Effect estimates**: Both unadjusted and bias-corrected HRs
4. **Uncertainty quantification**: 95% confidence intervals
5. **Stability assessment**: Bootstrap success rate, factor frequencies
6. **Clinical interpretation**: Practical implications for treatment decisions

### Tables to Include

- **Table 1**: Data summary and subgroup characteristics
- **Table 2**: Treatment effect estimates by subgroup
- **Table 3**: Bootstrap diagnostics and success metrics
- **Table 4**: Factor presence and stability
- **Table 5**: Agreement with original analysis (if applicable)

---

# 11. Limitations & Considerations

## Statistical Limitations

::: {.callout-warning}
## Multiple Testing

Subgroup searches involve **extensive multiple comparisons**. The consistency criterion helps control false discoveries, but results should still be interpreted cautiously and validated in independent data.
:::

## Data Requirements

- **Large sample sizes**: Small trials may not have sufficient power
- **Adequate events**: Low event rates limit subgroup analysis
- **Covariate quality**: Missing or poorly measured covariates reduce performance

## Clinical Considerations

- **Biological plausibility**: Identified subgroups should make clinical sense
- **External validation**: Findings should be replicated in independent cohorts
- **Treatment landscape**: Consider current standard of care and alternatives

## Computational Considerations

- **Time requirements**: Bootstrap can take hours for large datasets
- **Memory usage**: Super-population approach requires substantial RAM
- **Reproducibility**: Always set seeds and document versions

---

# 12. Summary & Conclusions

## Key Takeaways

1. **AFT-DGM provides flexible simulation framework** for generating realistic clinical trial data with controlled treatment-subgroup interactions

2. **Calibration enables precise control** over effect sizes, allowing researchers to test methods under known ground truth conditions

3. **Forest search systematically identifies subgroups** through multi-stage approach combining machine learning (GRF), variable selection (LASSO), and exhaustive search

4. **Bootstrap inference quantifies uncertainty** and corrects for optimism bias inherent in data-driven subgroup selection

5. **Bias correction can be substantial** (19% in example), highlighting importance of rigorous validation

6. **Factor stability analysis reveals** which variables consistently predict differential treatment effects

## Methodological Innovations

- **Quantile-based subgroup definitions**: More flexible than fixed cutpoints
- **Automated calibration**: Achieves target HRs efficiently
- **Consistency validation**: Ensures findings are not spurious
- **Comprehensive bootstrap diagnostics**: Multiple perspectives on stability

## Future Directions

- **Adaptive designs**: Incorporate subgroup findings into trial design
- **Machine learning integration**: Deep learning for complex interactions
- **Causal inference**: Formal causal frameworks for subgroup effects
- **Multi-arm trials**: Extend to multiple treatment comparisons
- **Time-varying effects**: Allow treatment effects to change over time

---

# References & Resources

## Key Packages

- **forestsearch**: Subgroup identification methodology
- **survival**: Survival analysis and Cox models
- **weightedsurv**: Weighted Kaplan-Meier estimation
- **grf**: Generalized random forests
- **doFuture**: Parallel processing infrastructure

## Documentation

- ForestSearch package documentation: [GitHub repository]
- GBSG dataset: Available in `survival` package
- AFT models: Kalbfleisch & Prentice (2002)
- Bootstrap inference: Efron & Tibshirani (1993)

## Citation

```bibtex
@article{forestsearch2024,
  title={Forest Search for Subgroup Identification in Clinical Trials},
  author={Author Names},
  journal={Journal Name},
  year={2024}
}
```

---

# Appendix: Parameter Reference

## generate_aft_dgm_flex() Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `data` | data.frame | — | Input dataset |
| `continuous_vars` | character | — | Continuous covariate names |
| `factor_vars` | character | — | Categorical covariate names |
| `outcome_var` | character | — | Survival time variable |
| `event_var` | character | — | Event indicator variable |
| `treatment_var` | character | NULL | Treatment variable (or simulated) |
| `subgroup_vars` | character | NULL | Variables defining subgroup |
| `subgroup_cuts` | list | NULL | Cutpoint specifications |
| `model` | character | "alt" | "alt" (with interaction) or "null" |
| `k_treat` | numeric | 1.0 | Treatment effect modifier |
| `k_inter` | numeric | 1.0 | Interaction effect modifier |
| `n_super` | integer | 5000 | Super-population size |
| `seed` | integer | 8316951 | Random seed |
| `verbose` | logical | TRUE | Print diagnostics |

## forestsearch() Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `df` | data.frame | — | Analysis dataset |
| `confounders.name` | character | — | Covariate names for subgroup definition |
| `outcome.name` | character | — | Survival time variable |
| `treat.name` | character | — | Treatment variable |
| `event.name` | character | — | Event indicator |
| `hr.threshold` | numeric | 1.25 | Minimum HR for "harm" |
| `hr.consistency` | numeric | 1.0 | Consistency validation threshold |
| `pconsistency.threshold` | numeric | 0.90 | Proportion for consistency |
| `maxk` | integer | 2 | Maximum factors per subgroup |
| `n.min` | integer | 60 | Minimum subgroup size |
| `d0.min` | integer | 12 | Minimum events in control |
| `d1.min` | integer | 12 | Minimum events in treatment |
| `use_grf` | logical | TRUE | Use GRF for cutpoint discovery |
| `use_lasso` | logical | TRUE | Use LASSO for variable selection |
| `parallel_args` | list | NULL | Parallel processing configuration |

---

*Document generated from AFT-DGM Examples analysis*
*Last updated: 2025*
