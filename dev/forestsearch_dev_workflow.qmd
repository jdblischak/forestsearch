---
title: "R Package Development Workflow with Git"
subtitle: "A Step-by-Step Guide for ForestSearch"
author: "ForestSearch Development Notes"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    code-fold: false
    theme: cosmo
    highlight-style: github
    self-contained: true
---


## Overview

This guide describes a Git-based development workflow for the ForestSearch
R package using GitHub Desktop and RStudio. The core principle is: **work
inside the package project, use branches for safety, and let Git be your
undo button.**

Two main activities are covered: refactoring R source code and developing
pkgdown vignettes. Both follow the same branching strategy.


## Project Directory Structure

```
forestsearch/
├── .github/
│   └── workflows/
│       ├── R-CMD-check.yaml        # CI: runs R CMD check on push
│       └── pkgdown.yaml            # CI: deploys site on push to main
├── R/                              # Package source (edit here)
├── man/                            # Auto-generated by roxygen2
├── data/                           # Package datasets
├── inst/extdata/                   # External data files
├── tests/testthat/                 # Unit tests
├── vignettes/
│   ├── forestsearch.Rmd            # CRAN vignette (ships with package)
│   └── articles/                   # pkgdown-only articles
│       ├── methodology.Rmd
│       ├── paper_simulations.Rmd
│       └── treatment_effect_definitions.Rmd
├── man/figures/                    # Logo, static images
├── scratch/                        # Exploratory work (.Rbuildignore'd)
├── _pkgdown.yml
├── DESCRIPTION
├── NAMESPACE
├── LICENSE
├── NEWS.md
├── README.md
└── .Rbuildignore
```

### Key Directories

**`R/`** --- All package functions live here. `devtools::load_all()` sources
every `.R` file in this directory. Never put scratch scripts here.

**`vignettes/`** --- The top-level `forestsearch.Rmd` is the CRAN vignette
(ships with the installed package, built during `R CMD check`). Files in
`vignettes/articles/` are pkgdown-only articles that appear on the website
but not in the CRAN tarball.

**`scratch/`** --- Optional directory for exploratory work. Add `^scratch$`
to `.Rbuildignore` so it's invisible to `R CMD build`. Once something here
matures, migrate it to `R/` or `vignettes/`.

**`man/`** and **`docs/`** --- Never edit directly. These are auto-generated
by `roxygen2` and `pkgdown` respectively.


## Branching Strategy

Three kinds of branches:

| Branch | Purpose | Quality gate |
|:---|:---|:---|
| `main` | Always passes `R CMD check` 0/0/0 | Merges trigger pkgdown deploy |
| `dev/feature-name` | Code changes in `R/` | Must pass `devtools::check()` |
| `docs/article-name` | Vignette work only | Must pass `pkgdown::build_article()` |

When a code change and a vignette change are coupled (e.g., adding a function
and documenting it in an article), use a single `dev/` branch for both.


## Refactoring R Source Code

### The Problem with File Copies

A natural instinct when refactoring `R/dothis.R` is to rename the old file
to `R/dothis_deprecated.R` and create a fresh `R/dothis.R`. **This causes
problems.** `devtools::load_all()` sources every `.R` file in `R/`. Both
files get loaded, and the second one silently overwrites the first. Which
version "wins" depends on alphabetical sort order --- fragile and confusing.

::: {.callout-warning}
### Never keep two `.R` files with the same function name

If `R/dothis.R` and `R/dothis_deprecated.R` both define `dothis()`,
`load_all()` will source both and only one survives (whichever loads last
alphabetically).
:::

### The Git Workflow (Recommended)

Use Git branches instead. The old version is always recoverable from commit
history without cluttering `R/`.


#### Step 1: Confirm main is clean

Run `devtools::check()` on `main` and confirm 0/0/0. Commit any uncommitted
changes. This is your known-good baseline.

```r
devtools::check()
#> 0 errors | 0 warnings | 0 notes
```


#### Step 2: Create a feature branch

In GitHub Desktop: **Current Branch** dropdown → **New Branch** →
name it descriptively (e.g., `dev/refactor-dothis`) → base on `main`.

GitHub Desktop switches to the new branch automatically. From this point on,
all changes happen on the branch and `main` is untouched.


#### Step 3: Edit `R/dothis.R` directly

Open the file in RStudio and rewrite the function in place. No copies, no
renaming. Save the file.

At this point, GitHub Desktop's **Changes** tab shows a diff highlighting
exactly what changed relative to `main`.


#### Step 4: Reload and test interactively

```r
devtools::load_all()

# Exercise the refactored function
result <- dothis(your_test_args)

# Verify expected behavior
stopifnot(identical(result$hr, expected_hr))
```

If something isn't right, keep editing and re-running `load_all()`. This
loop is fast --- no installation required.


#### Step 5: Compare old vs. new behavior

This is the key advantage of Git. Three approaches, from simplest to most
thorough:

**5a. Visual diff in GitHub Desktop**

Click on `R/dothis.R` in the Changes tab. The diff pane shows old code (red)
alongside new code (green), line by line. You can read the old implementation
without needing a separate file.

**5b. Temporarily revert to old version**

In the RStudio terminal:

```bash
git stash
```

This temporarily restores `R/dothis.R` to the `main` version. Run
`load_all()`, capture the old output, then restore your changes:

```bash
git stash pop
```

Now `load_all()` again to get back to your refactored version.

**5c. Run both versions in one session**

Copy just the old function body from the diff view and paste it into the R
console with a temporary name:
```r
# Paste from the diff --- session-only, not saved anywhere
dothis_old <- function(...) {
  # old implementation from diff
}

# Compare outputs
old_result <- dothis_old(test_args)
new_result <- dothis(test_args)
all.equal(old_result, new_result)
```

This lives only in your console session, never in a file.


#### Step 6: Update documentation

If the function signature changed (new parameters, renamed arguments),
regenerate documentation:

```r
devtools::document()
```

This updates `man/dothis.Rd` from the roxygen2 block in `R/dothis.R`.


#### Step 7: Run the full check

```r
devtools::check()
```

Confirm 0 errors, 0 warnings, 0 notes. If the function is used in a
vignette, also preview the affected article:

```r
pkgdown::build_article("articles/methodology")
```


#### Step 8: Commit on the feature branch

In GitHub Desktop, review the **Changes** tab one final time. The diff shows
every line you changed. Write a descriptive commit message:

> Refactor dothis() to extract coefficients directly (20% speedup)

Click **Commit to dev/refactor-dothis**.


#### Step 9: Merge to main

In GitHub Desktop:

1. Switch to `main` (**Current Branch** dropdown → `main`)
2. **Branch** menu → **Merge into Current Branch**
3. Select `dev/refactor-dothis` → **Merge**
4. **Push** to GitHub

If there are no conflicts (there shouldn't be if you're the only one
editing this file), the merge completes immediately.


#### Step 10: Delete the feature branch

In GitHub Desktop: **Branch** menu → **Delete** → confirm.

The full history of what you changed is preserved in the merge commit on
`main`.


### What's happening at each stage

| Stage | `main` | `dev/refactor-dothis` |
|:---|:---|:---|
| Before Step 2 | Old `dothis()` ✓ | Does not exist |
| Steps 3--7 | Old `dothis()` ✓ (untouched) | New `dothis()` (in progress) |
| After Step 9 | New `dothis()` ✓ | Merged, deletable |
| If abandoned | Old `dothis()` ✓ (never changed) | Deleted, no trace |

::: {.callout-tip}
### Abandoning a refactoring

At any point before Step 9, you can discard everything: switch to `main` in
GitHub Desktop, then delete the feature branch. The old `dothis()` is intact,
as if you never started.
:::


## Developing pkgdown Vignettes

### Edit in place

Always edit vignettes in their final location (`vignettes/articles/`). Never
draft in a separate folder and copy in later --- relative paths to
`references.bib`, data files, and `library(forestsearch)` calls depend on
the file being in its correct location.

Use `eval = FALSE` on chunks that aren't ready yet, and build incrementally.


### Preview commands

| Goal | Command |
|:---|:---|
| Preview one article | `pkgdown::build_article("articles/methodology")` |
| Preview the full site | `pkgdown::build_site()` |
| Validate pkgdown config | `pkgdown::check_pkgdown()` |
| Build CRAN vignette only | `devtools::build_vignettes()` |

Always prefer `build_article()` during development --- it's much faster than
`build_site()`.


### Branch workflow for vignettes

Same pattern as code refactoring, with a `docs/` prefix:

```
# Create branch
docs/treatment-effect-definitions

# Edit vignettes/articles/treatment_effect_definitions.Rmd

# Preview
pkgdown::build_article("articles/treatment_effect_definitions")

# Commit, merge to main, delete branch
```


## Vignette Format Conventions

All ForestSearch articles use `.Rmd` with the `knitr::rmarkdown` engine
(not Quarto `.qmd`) for reliable pkgdown rendering.

### Standard YAML header

```yaml
---
title: "Article Title"
subtitle: "Descriptive Subtitle"
author: "ForestSearch Package Documentation"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    code_folding: hide
    theme: cosmo
    highlight: tango
    fig_width: 8
    fig_height: 6
vignette: >
  %\VignetteIndexEntry{Article Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```

### Standard setup chunk

Every article includes the Bootstrap 5 code-folding hook for pkgdown
compatibility:

````r
```{r setup, include=FALSE}`r ''`
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.align = "center",
  fig.width = 8,
  fig.height = 6
)

# Bootstrap 5 code-folding hook for pkgdown compatibility
# Usage: add `echo=FALSE, code_fold=TRUE` to any chunk header
knitr::knit_hooks$set(code_fold = function(before, options, envir) {
  if (!before && isTRUE(options$code_fold)) {
    id <- gsub("[^a-zA-Z0-9]", "", options$label)
    code_lines <- knitr::knit_code$get(options$label)
    code_text  <- htmltools::htmlEscape(paste(code_lines, collapse = "\n"))
    sprintf(
      '<p><a class="btn btn-outline-secondary btn-sm"
      data-bs-toggle="collapse" href="#collapse-%s"
      role="button" aria-expanded="false"
      aria-controls="collapse-%s">
      <i class="bi bi-code-slash"></i> Code</a></p>
      <div class="collapse" id="collapse-%s">
      <div class="card card-body p-0">
      <pre class="r"><code class="hljs">%s</code></pre>
      </div></div>',
      id, id, id, code_text
    )
  }
})
```
````

### gt tables

Use bare `gt()` pipe chains --- they auto-print correctly under
`knitr::rmarkdown`. Apply `echo=FALSE, code_fold=TRUE` to table chunks so
the code is hidden by default with a toggle button:

````r
```{r my-table, echo=FALSE, code_fold=TRUE}`r ''`
gt(df) |>
  tab_header(title = "My Table") |>
  tab_style(...)
```
````

::: {.callout-important}
### Avoid Quarto's `quarto::html` engine for pkgdown articles

pkgdown renders Quarto articles with `minimal: true` and `theme: none`,
which strips gt's CSS and produces blank tables. The `knitr::rmarkdown`
engine handles gt output natively.
:::

### Figure dimensions

Set `fig.width` and `fig.height` in **both** the YAML header and
`knitr::opts_chunk$set()`. The YAML sets the `html_document` device
defaults; `opts_chunk$set()` is what knitr actually reads at render time.

DiagrammeR widgets (`grViz()`) ignore both and require their own `width`
and `height` arguments in pixels:

```r
grViz("digraph { ... }", width = 500, height = 600)
```

### Valid highlight styles

For `html_document`, valid options are: `default`, `tango`, `pygments`,
`kate`, `monochrome`, `espresso`, `zenburn`, `haddock`, `breezedark`,
`textmate`, `arrow`, `rstudio`. The Quarto style `github` is not valid.


## Deployment

### Local preview

```r
pkgdown::build_site()
# Opens in browser automatically
```

### GitHub Pages deployment

`pkgdown::deploy_to_branch()` builds the site and pushes to the `gh-pages`
branch. Typically this is automated via a GitHub Action that runs on push to
`main`:

```yaml
# .github/workflows/pkgdown.yaml
on:
  push:
    branches: [main]
    paths:
      - 'R/**'
      - 'vignettes/**'
      - '_pkgdown.yml'
      - 'DESCRIPTION'
```


## Quick Reference

### Common devtools commands

| Command | Purpose |
|:---|:---|
| `devtools::load_all()` | Source all `R/` files without installing |
| `devtools::document()` | Regenerate `man/` from roxygen2 |
| `devtools::check()` | Full `R CMD check` |
| `devtools::test()` | Run testthat tests only |
| `devtools::build_vignettes()` | Build CRAN vignettes |

### Common pkgdown commands

| Command | Purpose |
|:---|:---|
| `pkgdown::build_article("articles/name")` | Preview one article |
| `pkgdown::build_site()` | Build full site locally |
| `pkgdown::deploy_to_branch()` | Build and push to `gh-pages` |
| `pkgdown::check_pkgdown()` | Validate `_pkgdown.yml` |

### Git rescue commands (RStudio terminal)

| Command | Purpose |
|:---|:---|
| `git stash` | Temporarily shelve all changes |
| `git stash pop` | Restore shelved changes |
| `git diff R/dothis.R` | See changes vs. last commit |
| `git checkout -- R/dothis.R` | Discard changes to one file |
| `git log --oneline -10` | Recent commit history |

### Things to never do

- Edit files in `man/` (roxygen2 overwrites them)
- Edit files in `docs/` (pkgdown overwrites them)
- Put scratch scripts in `R/` (`load_all()` will source them)
- Keep two `.R` files with the same function name
- Draft vignettes outside of `vignettes/` and copy them in later
- Use `quarto::html` engine for pkgdown articles with gt tables
