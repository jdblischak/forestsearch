data = df_gbsg,
continuous_vars = c("age", "size", "pgr","erlog"),
factor_vars = c("meno", "grade"),
set_beta_spec = list(set_var = c("z_meno"), beta_var = -log(4)),
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
subgroup_vars = NULL,
subgroup_cuts = NULL,
model = "alt",
spline_spec = list(
var = "z_erlog",  # Use original variable name (or "z_er" if transformed)
knot = log(5),
zeta = log(20),
log_hrs = log(c(1.5, 0.9, 0.6))  # HR varies with ER
),
k_inter = 0.0,  # Amplify meno subgroup effect
verbose = TRUE
)
# Plot the spline effect
plot_spline_treatment_effect(dgm_spline)
dgm_spline$model_params$b0
dgm_spline$model_params$censoring$gamma
names(dgm_spline$df_super)
# Simulate data
set.seed(123)
draw_spline <- simulate_from_dgm(
dgm = dgm_spline,
n = 700,
rand_ratio = 1,
draw_treatment = TRUE,
max_follow = Inf,
seed = 123
)
result <- cox_cs_fit(
df = draw_spline, tte_name = "y_sim", event_name ="event_sim", treat_name = "treat_sim",
truebeta_name = "loghr_po",
z_name = "z_erlog", z_by = 0.25, z_window = 0.125,
alpha = 0.20,
plot_params = list(
xlab = "Biomarker Level",
main_title = "Treatment Effect Heterogeneity"
)
)
# dfp <- data.table::setorder(draw_spline,z_erlog)
# with(dfp, plot(z_erlog, loghr_po, type="l", lty=1))
# Specify critical HR threshold
results <- plot_subgroup_effects(dgm_spline$df_super, z ="z_erlog", hrz_crit = 0)
# Find "k" to achieve target HR in subgroup
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 2.0,
data = df_gbsg,
outcome_var = "rfstime",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("er", "meno"),
subgroup_cuts = list(
er = list(type = "quantile", value = er_quantile),
meno = 0
),
k_treat = 1.0,
verbose = FALSE
)
# Generate DGM with calibrated interaction
dgm_alt <- generate_aft_dgm_flex(
data = df_gbsg,
n_super = 5000,
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
subgroup_vars = c("er", "meno"),
subgroup_cuts = list(
er = list(type = "quantile", value = er_quantile),
meno = 0
),
model = "alt",
k_inter = result$k_inter,
verbose = FALSE
)
# Simulate data
set.seed(123)
draw_alt <- simulate_from_dgm(
dgm = dgm_alt,
n = 700,
rand_ratio = 1,
max_follow = Inf,
seed = 123
)
# Summary statistics
alt_summary <- data.frame(
Metric = c("Sample Size", "Event Rate", "Treatment Allocation",
"Subgroup Size", "Subgroup Proportion"),
Value = c(nrow(draw_alt),
mean(draw_alt$event_sim),
mean(draw_alt$treat_sim),
sum(draw_alt$flag_harm),
mean(draw_alt$flag_harm))
)
kable(alt_summary, digits = 3) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Prepare data for KM plot
dfcount_alt <- df_counting(
df = draw_alt,
tte.name = "y_sim",
event.name = "event_sim",
treat.name = "treat_sim"
)
# Create KM plot
par(mfrow=c(1,1))
plot_weighted_km(dfcount_alt, conf.int = TRUE, show.logrank = TRUE, ymax = 1.05)
title(main = "Alternative Scenario: With Treatment-Subgroup Interaction")
# Define confounders for forest search
confounders.name <- c("z_age", "z_er", "z_pgr", "z_meno",
"z_grade_1", "z_grade_2", "size", "nodes")
# Setup parallel processing
library(doFuture)
library(doRNG)
registerDoFuture()
registerDoRNG()
df_null <- as.data.frame(draw_null)
system.time({fs <- forestsearch(df_null,  confounders.name=confounders.name,
outcome.name = "y_sim", treat.name = "treat_sim", event.name = "event_sim", id.name = "id",
potentialOutcome.name = "loghr_po", flag_harm.name = "flag_harm",
hr.threshold = 1.25, hr.consistency = 1.0, pconsistency.threshold = 0.90,
sg_focus = "hrMaxSG",
showten_subgroups = FALSE, details=TRUE,
conf_force = c("z_age <= 65", "z_er <= 0", "z_er <= 1", "z_er <= 2","z_er <= 5"),
cut_type = "default", use_grf = TRUE, plot.grf = TRUE, use_lasso = TRUE,
maxk = 1, n.min = 60, d0.min = 12, d1.min = 12,
plot.sg = TRUE, by.risk = 120,
parallel_args = list(plan="callr", workers = 12, show_message = TRUE)
)
})
plan("sequential")
confounders.name <- c("z_age", "z_er", "z_pgr", "z_meno",
"z_grade_1", "z_grade_2", "size", "nodes")
# Setup parallel processing
library(doFuture)
library(doRNG)
registerDoFuture()
registerDoRNG()
df_alt <- as.data.frame(draw_alt)
system.time({fs <- forestsearch(df_alt,  confounders.name=confounders.name,
outcome.name = "y_sim", treat.name = "treat_sim", event.name = "event_sim", id.name = "id",
hr.threshold = 1.25, hr.consistency = 1.0, pconsistency.threshold = 0.90,
potentialOutcome.name = "loghr_po", flag_harm.name = "flag_harm",
sg_focus = "hrMaxSG",
showten_subgroups = FALSE, details=TRUE,
conf_force = c("z_age <= 65", "z_er <= 0", "z_er <= 1", "z_er <= 2","z_er <= 5"),
cut_type = "default", use_grf = TRUE, plot.grf = TRUE, use_lasso = TRUE,
maxk = 1, n.min = 60, d0.min = 12, d1.min = 12,
plot.sg = TRUE, by.risk = 12,
parallel_args = list(plan="callr", workers = 120, show_message = TRUE)
)
})
with(fs$df.est, table(flag_harm, treat.recommend))
# Extract results
res_tabs <- sg_tables(fs, ndecimals = 3)
res_tabs$sg10_out
res_tabs$tab_estimates
df_gbsg <- gbsg
df_gbsg$tte <- with(gbsg, rfstime/30.4375)
# Find k_inter for HR_harm = 2.0
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 2.0,
data = gbsg,
outcome_var = "rfstime",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("meno"),
subgroup_cuts = list(
meno = 0
),
k_treat = 1.0,
k_inter = 1.0,
verbose = FALSE
)
# Find k_inter for HR_harm = 2.0
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 0.6,
data = gbsg,
outcome_var = "rfstime",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("meno"),
subgroup_cuts = list(
meno = 1
),
k_treat = 1.0,
k_inter = 1.0,
verbose = FALSE
)
# Find k_inter for HR_harm = 2.0
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 2.0,
data = df_gbsg,
outcome_var = "rfstime",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("meno"),
subgroup_cuts = list(
meno = 1
),
k_treat = 1.0,
k_inter = 1.0,
verbose = FALSE
)
# Find k_inter for HR_harm = 2.0
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 2.0,
data = df_gbsg,
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("meno"),
subgroup_cuts = list(
meno = 1
),
k_treat = 1.0,
verbose = FALSE
)
# Find k_inter for HR_harm = 2.0
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 2.0,
data = df_gbsg,
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("er", "meno"),
subgroup_cuts = list(
er = list(type = "quantile", value = er_quantile),
meno = 0
),
k_treat = 1.0,
verbose = FALSE
)
# Transform time to months
df_gbsg <- gbsg
df_gbsg$tte <- with(gbsg, rfstime/30.4375)
# Find k_inter for HR_harm = 2.0
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 2.0,
data = df_gbsg,
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("er", "meno"),
subgroup_cuts = list(
er = list(type = "quantile", value = er_quantile),
meno = 0
),
k_treat = 1.0,
verbose = FALSE
)
calibration_results <- data.frame(
Target_HR = 2.0,
Optimal_k_inter = round(result$k_inter, 4),
Achieved_HR = round(result$achieved_hr_harm, 4),
Error = round(result$error, 6)
)
kable(calibration_results,
col.names = c("Target HR", "Optimal k_inter", "Achieved HR", "Error")) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 2.0,
data = df_gbsg,
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("er"),
subgroup_cuts = list(
er = list(type = "quantile", value = er_quantile),
),
k_treat = 1.0,
verbose = FALSE
)
er_quantile
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 2.0,
data = df_gbsg,
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("er"),
subgroup_cuts = list(
er = list(type = "quantile", value = er_quantile)
),
k_treat = 1.0,
verbose = FALSE
)
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 2.0,
data = df_gbsg,
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("meno"),
subgroup_cuts = list(
meno = 0
),
k_treat = 1.0,
verbose = FALSE
)
result
# Find k_inter for HR_harm = 2.0
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 2.0,
data = df_gbsg,
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("er", "meno"),
subgroup_cuts = list(
er = list(type = "quantile", value = er_quantile),
meno = 0
),
k_treat = 1.0,
verbose = FALSE
)
result
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 2.0,
data = df_gbsg,
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("meno"),
subgroup_cuts = list(
meno = 0
),
k_treat = 1.0,
verbose = FALSE
)
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 2.0,
data = df_gbsg,
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("meno"),
subgroup_cuts = list(
meno = 0
),
k_treat = 1.0,
verbose = TRUE
)
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 1.0,
data = df_gbsg,
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("meno"),
subgroup_cuts = list(
meno = 0
),
k_treat = 1.0,
verbose = TRUE
)
help(find_k_inter_for_target_hr)
help(generate_aft_dgm_flex)
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 1.0,
data = df_gbsg,
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("er"),
subgroup_cuts = list(
er <= 1
),
k_treat = 1.0,
verbose = TRUE
)
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 1.0,
data = df_gbsg,
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("er"),
subgroup_cuts = list(
er = list(type = "custom",
fun = function(x) x <= 1)
),
k_treat = 1.0,
verbose = TRUE
)
result <- forestsearch::find_k_inter_for_target_hr(
target_hr_harm = 2.0,
data = df_gbsg,
outcome_var = "tte",
event_var = "status",
treatment_var = "hormon",
continuous_vars = c("age", "er", "pgr"),
factor_vars = c("meno", "grade"),
subgroup_vars = c("er"),
subgroup_cuts = list(
er = list(type = "custom",
fun = function(x) x <= 1)
),
k_treat = 1.0,
verbose = TRUE
)
names(dgm_null)
dgm_null$model_params
dgm_alt$model_params
names(dgm_spline)
dgm_spline$model_params
names(dgm_spline$df_super)
with(dgm_spline$df_super,table(event))
with(dgm_spline$df_super,mean(event))
with(gbsg,mean(status))
names(dgm_spline$hazard_ratios)
dgm_spline$hazard_ratios
# Simulate data
set.seed(123)
draw_spline <- simulate_from_dgm(
dgm = dgm_spline,
n = 700,
rand_ratio = 1,
draw_treatment = TRUE,
max_follow = Inf,
seed = 123
)
result <- cox_cs_fit(
df = draw_spline, tte_name = "y_sim", event_name ="event_sim", treat_name = "treat_sim",
truebeta_name = "loghr_po",
z_name = "z_erlog", z_by = 0.25, z_window = 0.125,
alpha = 0.20,
plot_params = list(
xlab = "Biomarker Level",
main_title = "Treatment Effect Heterogeneity"
)
)
# Prepare data for KM plot
dfcount_alt <- df_counting(
df = draw_alt,
tte.name = "y_sim",
event.name = "event_sim",
treat.name = "treat_sim"
)
# Create KM plot
par(mfrow=c(1,1))
plot_weighted_km(dfcount_alt, conf.int = TRUE, show.logrank = TRUE, ymax = 1.05)
title(main = "Alternative Scenario: With Treatment-Subgroup Interaction")
# Simulate data
set.seed(123)
draw_alt <- simulate_from_dgm(
dgm = dgm_alt,
n = 1000,
rand_ratio = 1,
max_follow = Inf,
seed = 123
)
# Summary statistics
alt_summary <- data.frame(
Metric = c("Sample Size", "Event Rate", "Treatment Allocation",
"Subgroup Size", "Subgroup Proportion"),
Value = c(nrow(draw_alt),
mean(draw_alt$event_sim),
mean(draw_alt$treat_sim),
sum(draw_alt$flag_harm),
mean(draw_alt$flag_harm))
)
kable(alt_summary, digits = 3) %>%
kable_styling(bootstrap_options = c("striped", "hover"))
# Prepare data for KM plot
dfcount_alt <- df_counting(
df = draw_alt,
tte.name = "y_sim",
event.name = "event_sim",
treat.name = "treat_sim"
)
# Create KM plot
par(mfrow=c(1,1))
plot_weighted_km(dfcount_alt, conf.int = TRUE, show.logrank = TRUE, ymax = 1.05)
title(main = "Alternative Scenario: With Treatment-Subgroup Interaction")
