---
title: "MRCT Consistency Evaluation"
author: "Larry Leon, Masashi Shimura, Xiaojing Cui, Kenichi Takahashi, Shuping Jiang, and William Wang"
#date: "`r Sys.Date()`"
output:
  beamer_presentation:
    theme: "Madrid"
---

```{r Setup, message=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
options(warn = -1)
rm(list=ls())
library(tinytex)
library(ggplot2)
library(table1)
library(gt)
library(survival)
library(data.table)
library(randomForest)
library(grf)
library(policytree)

library(grid)
library(forestploter)
library(randomizr)

codepath <- c("Rcode/forestsearch/R/")
source(paste0(codepath,"source_forestsearch_v0.R"))
source_fs_functions(file_loc=codepath)

# library(devtools)
# github_install("larry-leon/weightedKM")

library(weightedKM)

```

## Overview: Exploratory Subgroup Identification Analyses

- Despite global trial success, AP consistency can be challenging (for many reasons); 
    - A subgroup (SG) may exist with *stronger* benefit
    - Can potentially be identified based on non-AP data 
- If **benefit** in identified SG translates to AP 
    - May enable consistency determination
- We describe an analysis paradigm and proof-of-concept *simulation* 



```{r, eval=FALSE}
# Analysis flow chart diagramme showing analysis "target" options
# Note: Evaluate within the chunk to first save results
# Save diagrams as png and then import
library(DiagrammeR)
library(DiagrammeRsvg)
library(rsvg)

graph_code <- 'digraph flowchart {
  node [shape = rectangle, style=filled, fillcolor=lightgrey]
  Start [label = "Non-AP data for subgroup identification"]
  
  Decision1 [label="Comprehensive evaluation of 
  biomarker(BM) and all disease/demographic factors;
  BM cuts e.g. {<1},{<2},...,{<10}", shape = box, fillcolor=lightblue]
  
  Analysis1 [label = "H with largest hr, min(hr)>=0.9", shape = rectangle, fillcolor=lightyellow]
  
  Analysis2 [label = "Smallest H, min(hr)>=0.9", shape = rectangle, fillcolor=lightyellow]
  
  Analysis3 [label = "Largest B, max(hr)<= 0.6", shape = rectangle, fillcolor=lightyellow]
  
  Start -> Decision1
  
  Decision1 -> Analysis1 [label="option"]
  Decision1 -> Analysis2 [label="option"]
  Decision1 -> Analysis3 [label="option"]
  
}'
mygraph <- grViz(graph_code)
# export graph

# export_svg(mygraph) %>%
#   charToRaw() %>%
#   rsvg() %>%
#   png::writePNG("MRCT-Flow-AnalysisOptions.png")

# Note: better to save as pdf for Rmarkdown
svg_code <- export_svg(mygraph)
writeLines(svg_code, "diagram1.svg")
rsvg_pdf("diagram1.svg", "diagram1.pdf")  # Convert SVG to PDF
```

## Analysis Flowchart

```{r, fig.height=5, fig.width=8}
knitr::include_graphics("diagram1.pdf")
```


```{r, eval=FALSE}
# Analysis flow chart --> steps after analysis "target" options
# Note: Evaluate within the chunk to first save results
# Save diagrams as png and then import
graph_code <- 'digraph flowchart {
  node [shape = rectangle, style=filled, fillcolor=lightgrey]
  Start [label = "Largest B, max(hr)<= 0.6", shape = rectangle, fillcolor=lightyellow]
  
  Decision2 [label="Benefiting subgroup G* biologically plausible?", shape=rectangle, fillcolor=lightgrey]
  
  Question1 [label = "Operating characteristics:
  false-discovery, estimation (bias,CI)", shape=diamond, fillcolor=lightgray]
  
  APanalysis [label="Primary analysis of AP
  within G* sub-population", shape=diamond, fillcolor=green]
  
  Start -> Decision2 [label="team conclusion"]
  Decision2 -> APanalysis[label="apply to AP"]
  
  APanalysis -> Question1 [label = "Data-driven 
  simulation (DdS):
  SG sizes per data;
  Outcome/censoring models
  based on data (Weibull fits)"]
  
}'
mygraph <- grViz(graph_code)

svg_code <- export_svg(mygraph)
writeLines(svg_code, "diagram2.svg")
rsvg_pdf("diagram2.svg", "diagram2.pdf")  # Convert SVG to PDF
```


## Analysis Flowchart Contd. {.shrink}
```{r, fig.align="center", out.width="60%"}
knitr::include_graphics("diagram2.pdf")
```


```{r}
# case-study example
df.case <- read.table("simdatasource/dfexplore.csv", header=TRUE, sep=",")

df.case <- within(df.case,{
  z <- pmin(biomarker,20)  # eg, PDL-1 expression truncated at 20
  CTregimen <- ifelse(mAD_CTregimen1==0,"socA","socB") # Outcome stratification (Weibull/Cox model)
  })

# These are confounders (fixed) that were characteristics from observed data
confounders.name <- c("age","biomarker","male","EU_region","AP_region","histology","surgery","ecog1","mAD_CTregimen1")

log.hrs <- log(c(3,1.25,0.50))
dgm <- get_dgm_stratified(df=df.case,zeta=10,knot=5,log.hrs=log.hrs,strata_tte=NULL,details=FALSE)
pop_summary <- draw_sim_stratified(dgm=dgm,ss=1,Ndraw=100000,wname="AP_region",bw=-log(5),strata_rand="stratum",checking=FALSE,details=FALSE,return_df=FALSE)

hr.5minus <- with(pop_summary,HRminus.zpoints[which(zpoints==5)])
hr.5plus <- with(pop_summary,HR.zpoints[which(zpoints==5)])

# An illustrative simulated example dataset
df_example <- draw_sim_stratified(dgm=dgm,ss=123,wname="AP_region",bw=-log(5),strata_rand="stratum")

df_nonAP <- subset(df_example,AP_region==0)
df_AP <- subset(df_example,AP_region==1)
df_ITT <- df_example
```

## Kaplan-Meier ITT Population

```{r, fig.height=5.5, fig.width=8}
# hard code HRs
hr.5minus <- 1.9
hr.5plus <- 0.40

hrtext_minus <- paste0("hr(bm<5) =",round(hr.5minus,1))
hrtext_plus <- paste0("hr(bm>=5) =",round(hr.5plus,1))
hrtext <- paste(hrtext_minus,hrtext_plus, sep="; ")

temp <- KM_plot_2sample_weighted(df=df_ITT, tte.name="y.sim", event.name="event.sim", treat.name="treat.sim", risk.set=TRUE, by.risk=6, show.cox=TRUE, risk_offset = 0.125, risk_delta = 0.05, col.1="black",col.2="blue", arm.cex=0.9, cox.cex=1.0, Xlab="Months",Ylab="Overall survival", arms=c("Experimental","Control"), show.med=TRUE)
title(main="ITT Population")
text(9,0.15,hrtext,cex=0.75)
```

## Kaplan-Meier Non-AP and AP Populations

```{r, fig.height = 6.5, fig.width = 10}
par(mfrow=c(1,2))
temp <- KM_plot_2sample_weighted(df=df_nonAP, tte.name="y.sim", event.name="event.sim", treat.name="treat.sim", risk.set=TRUE, by.risk=6, show.cox=TRUE, risk_offset = 0.125, risk_delta = 0.05, col.1="black",col.2="blue", arm.cex=0.9, cox.cex=1.0, Xlab="Months",Ylab="Overall survival", arms=c("Experimental","Control"),
                                 put.legend.arms="right")
title(main="Non-AP Population")
temp <- KM_plot_2sample_weighted(df=df_AP, tte.name="y.sim", event.name="event.sim", treat.name="treat.sim", risk.set=TRUE, by.risk=6, show.cox=TRUE, risk_offset = 0.125, risk_delta = 0.05, col.1="black",col.2="blue", arm.cex=0.7, cox.cex=1.0, Xlab="Months",Ylab="Overall survival", arms=c("Experimental","Control"), show_arm_legend=FALSE)
title(main="AP Population")
```

```{r,eval=FALSE}
# Note: Evaluate within the chunk to first save results
# sg_focus="MinSG" selects smallest subgroup meeting selection criteria

fs <- forestsearch(df.analysis=df_nonAP, df.test=df_AP, confounders.name=confounders.name,
outcome.name="y.sim",treat.name="treat.sim", event.name="event.sim",
potentialOutcome.name="loghr.po",
hr.threshold = 0.90, hr.consistency = 0.80, pconsistency.threshold = 0.90,
sg_focus = "minSG",
showten_subgroups=TRUE, details=TRUE,
conf_force=c("age <= 65","biomarker < 1","biomarker < 2","biomarker < 3",
"biomarker < 4","biomarker < 5","biomarker < 6","biomarker < 7","biomarker < 8",
"biomarker < 9","biomarker < 10"), exclude_cuts=c("biomarker <="),
maxk=1, plot.sg=FALSE)

# Note: Set plot.sg=FALSE to turn off plotting --> needs to be updated to use weightKM package

save(fs,file="SimExample_FSanalysis.Rdata")

```



## Example: Biomarker Subgroups Identified (non-AP) {.shrink}

```{r, results="asis"}
load(file="SimExample_FSanalysis.Rdata")
# Consistency for subgroups contained in "grp.consistency"
sg_tables(fs=fs,which_df="est",est_caption="Non-AP (training) estimates")$sg10_out
```



## AP Population ITT

```{r, fig.height = 6.5, fig.width = 10}

temp <- KM_plot_2sample_weighted(df = df_AP, tte.name="y.sim", event.name="event.sim", treat.name="treat.sim", risk.set=TRUE, by.risk=6, show.cox=TRUE, risk_offset = 0.125, risk_delta = 0.05,
                                 show.logrank = FALSE, put.legend.lr="left", logrank.cex=1.0, col.1="black",col.2="blue", arm.cex=0.9, cox.cex=1.0, Xlab="Months",Ylab="Overall survival", arms=c("Experimental","Control"),
                                 put.legend.arms="left")
title(main="AP Population")
```


## AP by biomarker low-vs-high (<2, >=2)

```{r, fig.height = 6.5, fig.width = 10}

par(mfrow=c(1,2))
temp <- KM_plot_2sample_weighted(df=subset(df_AP, biomarker < 2), tte.name="y.sim", event.name="event.sim", treat.name="treat.sim", risk.set=TRUE, by.risk=6, show.cox=TRUE, risk_offset = 0.125, risk_delta = 0.05,
                                 show.logrank = FALSE, put.legend.lr="left", logrank.cex=1.0, col.1="black",col.2="blue", arm.cex=0.9, cox.cex=1.0, Xlab="Months",Ylab="Overall survival", arms=c("Experimental","Control"),
                                 put.legend.arms="right")
title(main="AP Population: BM < 2")
temp <- KM_plot_2sample_weighted(df=subset(df_AP, biomarker >=2), tte.name="y.sim", event.name="event.sim", treat.name="treat.sim", risk.set=TRUE, by.risk=6, show.cox=TRUE, show.logrank=FALSE, risk_offset = 0.125, risk_delta = 0.05, col.1="black",col.2="blue", put.legend.lr="left", logrank.cex=1.0, arm.cex=0.7, cox.cex=1.0, Xlab="Months",Ylab="Overall survival", arms=c("Experimental","Control"), show_arm_legend=FALSE)
title(main="AP Population: BM >= 2")
```


