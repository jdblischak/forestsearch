# non-AP
dfc0 <- df_counting(
df = df_nonAP,
by.risk = 6,
tte.name = "y_sim",
event.name = "event_sim",
treat.name = "treat_sim"
)
# AP
dfc1 <- df_counting(
df = df_AP,
by.risk = 6,
tte.name = "y_sim",
event.name = "event_sim",
treat.name = "treat_sim"
)
par(mfrow=c(2,2))
plot_weighted_km(dfideal, conf.int = FALSE, show.logrank = TRUE, ymax = 1.05)
plot_weighted_km(dfc, conf.int = FALSE, show.logrank = TRUE, ymax = 1.05)
plot_weighted_km(dfc0, conf.int = FALSE, show.logrank = TRUE, ymax = 1.05)
plot_weighted_km(dfc1, conf.int = FALSE, show.logrank = TRUE, ymax = 1.05)
# Simulate data
df_example <- simulate_from_dgm(
dgm = dgm_spline,
n = 500,
rand_ratio = 1,
draw_treatment = TRUE,
max_follow = 100,
seed = 1235
)
# ITT
dfc <- df_counting(
df = df_example,
by.risk = 6,
tte.name = "y_sim",
event.name = "event_sim",
treat.name = "treat_sim"
)
# No censoring
# Except by max_follow
df_example$t_true <- pmin(df_example$t_true, 100)
df_example$event_mod <- ifelse(df_example$t_true <= 100,1,0)
dfideal <- df_counting(
df = df_example,
by.risk = 6,
tte.name = "t_true",
event.name = "event_mod",
treat.name = "treat_sim"
)
df_nonAP <- subset(df_example, z_AP == 0)
df_AP <- subset(df_example, z_AP == 1)
# non-AP
dfc0 <- df_counting(
df = df_nonAP,
by.risk = 6,
tte.name = "y_sim",
event.name = "event_sim",
treat.name = "treat_sim"
)
# AP
dfc1 <- df_counting(
df = df_AP,
by.risk = 6,
tte.name = "y_sim",
event.name = "event_sim",
treat.name = "treat_sim"
)
par(mfrow=c(2,2))
plot_weighted_km(dfideal, conf.int = FALSE, show.logrank = TRUE, ymax = 1.05)
title("ITT no random censoring")
plot_weighted_km(dfc, conf.int = FALSE, show.logrank = TRUE, ymax = 1.05)
title("ITT censored")
plot_weighted_km(dfc0, conf.int = FALSE, show.logrank = TRUE, ymax = 1.05)
title("non-AP")
plot_weighted_km(dfc1, conf.int = FALSE, show.logrank = TRUE, ymax = 1.05)
title("AP")
confounders.name <- c("z_age","z_bm","z_male","ecog","z_region_other","z_histology","z_prior_treat","z_strat")
dfa <- as.data.frame(df_nonAP)
# Setup parallel processing
library(doFuture)
library(doRNG)
registerDoFuture()
registerDoRNG()
system.time({fs <- forestsearch(dfa,  confounders.name=confounders.name,
outcome.name = "y_sim", treat.name = "treat_sim", event.name = "event_sim", id.name = "id",
potentialOutcome.name = "loghr_po", flag_harm.name = NULL,
hr.threshold = 0.90, hr.consistency = 0.80, pconsistency.threshold = 0.80,
sg_focus = "minSG", max_subgroups_search = 30,
showten_subgroups = TRUE, details=TRUE,
conf_force = c("z_age <= 65", "z_bm <= 0", "z_bm <= 1", "z_bm <= 2","z_bm <= 5"),
cut_type = "default", use_grf = TRUE, plot.grf = TRUE, use_lasso = FALSE,
maxk = 1, n.min = 60, d0.min = 12, d1.min = 12,
plot.sg = TRUE, by.risk = 6,
parallel_args = list(plan="callr", workers = 12, show_message = TRUE)
)
})
confounders.name <- c("z_age","z_bm","z_male","ecog","region_other","histology","z_prior_treat","strat")
dfa <- as.data.frame(df_nonAP)
# Setup parallel processing
library(doFuture)
library(doRNG)
registerDoFuture()
registerDoRNG()
system.time({fs <- forestsearch(dfa,  confounders.name=confounders.name,
outcome.name = "y_sim", treat.name = "treat_sim", event.name = "event_sim", id.name = "id",
potentialOutcome.name = "loghr_po", flag_harm.name = NULL,
hr.threshold = 0.90, hr.consistency = 0.80, pconsistency.threshold = 0.80,
sg_focus = "minSG", max_subgroups_search = 30,
showten_subgroups = TRUE, details=TRUE,
conf_force = c("z_age <= 65", "z_bm <= 0", "z_bm <= 1", "z_bm <= 2","z_bm <= 5"),
cut_type = "default", use_grf = TRUE, plot.grf = TRUE, use_lasso = FALSE,
maxk = 1, n.min = 60, d0.min = 12, d1.min = 12,
plot.sg = TRUE, by.risk = 6,
parallel_args = list(plan="callr", workers = 12, show_message = TRUE)
)
})
confounders.name <- c("z_age","z_bm","z_male","ecog","region_other","z_histology","z_prior_treat","strat")
dfa <- as.data.frame(df_nonAP)
# Setup parallel processing
library(doFuture)
library(doRNG)
registerDoFuture()
registerDoRNG()
system.time({fs <- forestsearch(dfa,  confounders.name=confounders.name,
outcome.name = "y_sim", treat.name = "treat_sim", event.name = "event_sim", id.name = "id",
potentialOutcome.name = "loghr_po", flag_harm.name = NULL,
hr.threshold = 0.90, hr.consistency = 0.80, pconsistency.threshold = 0.80,
sg_focus = "minSG", max_subgroups_search = 30,
showten_subgroups = TRUE, details=TRUE,
conf_force = c("z_age <= 65", "z_bm <= 0", "z_bm <= 1", "z_bm <= 2","z_bm <= 5"),
cut_type = "default", use_grf = TRUE, plot.grf = TRUE, use_lasso = FALSE,
maxk = 1, n.min = 60, d0.min = 12, d1.min = 12,
plot.sg = TRUE, by.risk = 6,
parallel_args = list(plan="callr", workers = 12, show_message = TRUE)
)
})
dim(df_nonAP)
names(df_nonAP)
fs <- forestsearch(df.analysis=df_nonAP, df.test=df_AP,
confounders.name=confounders.name,
outcome.name="y.sim", treat.name="treat.sim", event.name="event.sim",
potentialOutcome.name="loghr.po",
hr.threshold = 0.90, hr.consistency = 0.80, pconsistency.threshold = 0.90,
sg_focus="minSG", details=TRUE,
conf_force=c("age <= 65","biomarker < 1","biomarker < 2","biomarker < 3",
"biomarker < 4","biomarker < 5","biomarker < 6","biomarker < 7","biomarker < 8",
"biomarker < 9","biomarker < 10"), exclude_cuts=c("biomarker <="), maxk=1)
fs <- forestsearch(df.analysis=df_nonAP, df.test=df_AP,
confounders.name=confounders.name,
outcome.name="y_sim", treat.name="treat_sim", event.name="event_sim",
potentialOutcome.name="loghr.po",
hr.threshold = 0.90, hr.consistency = 0.80, pconsistency.threshold = 0.90,
sg_focus="minSG", details=TRUE,
conf_force=c("age <= 65","biomarker < 1","biomarker < 2","biomarker < 3",
"biomarker < 4","biomarker < 5","biomarker < 6","biomarker < 7","biomarker < 8",
"biomarker < 9","biomarker < 10"), exclude_cuts=c("biomarker <="), maxk=1)
fs <- forestsearch(df.analysis=df_nonAP, df.test=df_AP,
confounders.name=confounders.name,
outcome.name="y_sim", treat.name="treat_sim", event.name="event_sim",
potentialOutcome.name="loghr_po",
hr.threshold = 0.90, hr.consistency = 0.80, pconsistency.threshold = 0.90,
sg_focus="minSG", details=TRUE,
conf_force=c("age <= 65","biomarker < 1","biomarker < 2","biomarker < 3",
"biomarker < 4","biomarker < 5","biomarker < 6","biomarker < 7","biomarker < 8",
"biomarker < 9","biomarker < 10"), exclude_cuts=c("biomarker <="), maxk=1)
names(dfa)
is.data.frame(dfa)
confounders.name
summary(dfa)
confounders.name <- c("z_age","z_bm","z_male","ecog","z_histology","z_prior_treat","strat")
dfa <- as.data.frame(df_nonAP)
# Setup parallel processing
library(doFuture)
library(doRNG)
registerDoFuture()
registerDoRNG()
system.time({fs <- forestsearch(dfa,  confounders.name=confounders.name,
outcome.name = "y_sim", treat.name = "treat_sim", event.name = "event_sim", id.name = "id",
potentialOutcome.name = "loghr_po", flag_harm.name = NULL,
hr.threshold = 0.90, hr.consistency = 0.80, pconsistency.threshold = 0.80,
sg_focus = "minSG", max_subgroups_search = 30,
showten_subgroups = TRUE, details=TRUE,
conf_force = c("z_age <= 65", "z_bm <= 0", "z_bm <= 1", "z_bm <= 2","z_bm <= 5"),
cut_type = "default", use_grf = TRUE, plot.grf = TRUE, use_lasso = FALSE,
maxk = 1, n.min = 60, d0.min = 12, d1.min = 12,
plot.sg = TRUE, by.risk = 6,
parallel_args = list(plan="callr", workers = 12, show_message = TRUE)
)
})
plan("sequential")
system.time({fs <- forestsearch(dfa,  confounders.name=confounders.name,
outcome.name = "y_sim", treat.name = "treat_sim", event.name = "event_sim", id.name = "id",
potentialOutcome.name = "loghr_po",
df.test = as.data.frame(df_AP),
flag_harm.name = NULL,
hr.threshold = 0.90, hr.consistency = 0.80, pconsistency.threshold = 0.80,
sg_focus = "minSG", max_subgroups_search = 30,
showten_subgroups = TRUE, details=TRUE,
conf_force = c("z_age <= 65", "z_bm <= 0", "z_bm <= 1", "z_bm <= 2","z_bm <= 5"),
cut_type = "default", use_grf = TRUE, plot.grf = TRUE, use_lasso = FALSE,
maxk = 1, n.min = 60, d0.min = 12, d1.min = 12,
plot.sg = TRUE, by.risk = 6,
parallel_args = list(plan="callr", workers = 12, show_message = TRUE)
)
})
plan("sequential")
confounders.name <- c("z_age","z_bm","z_male","ecog","z_histology","z_prior_treat","strat")
dfa <- as.data.frame(df_nonAP)
# Setup parallel processing
library(doFuture)
library(doRNG)
registerDoFuture()
registerDoRNG()
system.time({fs <- forestsearch(dfa,  confounders.name=confounders.name,
outcome.name = "y_sim", treat.name = "treat_sim", event.name = "event_sim", id.name = "id",
potentialOutcome.name = "loghr_po",
df.test = as.data.frame(df_AP),
flag_harm.name = NULL,
hr.threshold = 0.90, hr.consistency = 0.80, pconsistency.threshold = 0.80,
sg_focus = "minSG", max_subgroups_search = 30,
showten_subgroups = TRUE, details=TRUE,
conf_force = c("z_age <= 65", "z_bm <= 0", "z_bm <= 1", "z_bm <= 2","z_bm <= 5"),
cut_type = "default", use_grf = TRUE, plot.grf = TRUE, use_lasso = FALSE,
maxk = 1, n.min = 60, d0.min = 12, d1.min = 12,
plot.sg = TRUE, by.risk = 6,
parallel_args = list(plan="callr", workers = 12, show_message = TRUE)
)
})
plan("sequential")
res_tabs <- sg_tables(fs, ndecimals = 3)
res_tabs$sg10_out
res_tabs$tab_estimates
names(res_tabs)
help(sg_tables)
res_tabs <- sg_tables(fs, ndecimals = 3, which_df = "testing")
res_tabs$tab_estimates
# Testing (AP)
res_tabs <- sg_tables(fs, ndecimals = 3, which_df = "testing", est_caption = "Testing (AP) dataset")
res_tabs$tab_estimates
dim(df_AP)
res_tabs$sg10_out
confounders.name <- c("z_age","z_bm","z_male","ecog","z_histology","z_prior_treat","strat")
dfa <- as.data.frame(df_nonAP)
# Setup parallel processing
library(doFuture)
library(doRNG)
registerDoFuture()
registerDoRNG()
system.time({fs <- forestsearch(dfa,  confounders.name=confounders.name,
outcome.name = "y_sim", treat.name = "treat_sim", event.name = "event_sim", id.name = "id",
potentialOutcome.name = "loghr_po",
df.test = as.data.frame(df_AP),
flag_harm.name = NULL,
hr.threshold = 0.90, hr.consistency = 0.80, pconsistency.threshold = 0.80,
sg_focus = "minSG", max_subgroups_search = 30,
showten_subgroups = TRUE, details=TRUE,
conf_force = c("z_age <= 65", "z_bm <= 0", "z_bm <= 1", "z_bm <= 2","z_bm <= 5"),
cut_type = "default", use_grf = TRUE, plot.grf = TRUE, use_lasso = FALSE,
maxk = 1, n.min = 60, d0.min = 12, d1.min = 12,
plot.sg = TRUE, by.risk = 6,
parallel_args = list(plan="callr", workers = 100, show_message = TRUE)
)
})
plan("sequential")
res_tabs <- sg_tables(fs, ndecimals = 3)
res_tabs$sg10_out
res_tabs$tab_estimates
# Testing (AP)
res_tabs <- sg_tables(fs, ndecimals = 3, which_df = "testing", est_caption = "Testing (AP) dataset")
res_tabs$tab_estimates
confounders.name <- c("z_age","z_bm","z_male","ecog","z_histology","z_prior_treat","strat")
dfa <- as.data.frame(df_nonAP)
# Setup parallel processing
library(doFuture)
library(doRNG)
registerDoFuture()
registerDoRNG()
system.time({fs <- forestsearch(dfa,  confounders.name=confounders.name,
outcome.name = "y_sim", treat.name = "treat_sim", event.name = "event_sim", id.name = "id",
potentialOutcome.name = "loghr_po",
df.test = as.data.frame(df_AP),
flag_harm.name = NULL,
hr.threshold = 0.90, hr.consistency = 0.80, pconsistency.threshold = 0.80,
sg_focus = "minSG", max_subgroups_search = 30,
showten_subgroups = TRUE, details=TRUE,
conf_force = c("z_age <= 65", "z_bm <= 0", "z_bm <= 1", "z_bm <= 2","z_bm <= 5"),
cut_type = "default", use_grf = TRUE, plot.grf = TRUE, use_lasso = TRUE,
maxk = 1, n.min = 60, d0.min = 12, d1.min = 12,
plot.sg = TRUE, by.risk = 6,
parallel_args = list(plan="callr", workers = 100, show_message = TRUE)
)
})
plan("sequential")
res_tabs <- sg_tables(fs, ndecimals = 3)
res_tabs$sg10_out
res_tabs$tab_estimates
# Testing (AP)
res_tabs <- sg_tables(fs, ndecimals = 3, which_df = "testing", est_caption = "Testing (AP) dataset")
res_tabs$tab_estimates
confounders.name <- c("z_age","z_bm","z_male","ecog","z_histology","z_prior_treat","strat")
dfa <- as.data.frame(df_nonAP)
# Setup parallel processing
library(doFuture)
library(doRNG)
registerDoFuture()
registerDoRNG()
system.time({fs <- forestsearch(dfa,  confounders.name=confounders.name,
outcome.name = "y_sim", treat.name = "treat_sim", event.name = "event_sim", id.name = "id",
potentialOutcome.name = "loghr_po",
df.test = as.data.frame(df_AP),
flag_harm.name = NULL,
hr.threshold = 1.25, hr.consistency = 0.80, pconsistency.threshold = 0.80,
sg_focus = "minSG", max_subgroups_search = 30,
showten_subgroups = TRUE, details=TRUE,
conf_force = c("z_age <= 65", "z_bm <= 0", "z_bm <= 1", "z_bm <= 2","z_bm <= 5"),
cut_type = "default", use_grf = TRUE, plot.grf = TRUE, use_lasso = TRUE,
maxk = 1, n.min = 60, d0.min = 12, d1.min = 12,
plot.sg = TRUE, by.risk = 6,
parallel_args = list(plan="callr", workers = 100, show_message = TRUE)
)
})
plan("sequential")
res_tabs <- sg_tables(fs, ndecimals = 3)
res_tabs$sg10_out
res_tabs$tab_estimates
# Testing (AP)
res_tabs <- sg_tables(fs, ndecimals = 3, which_df = "testing", est_caption = "Testing (AP) dataset")
res_tabs$tab_estimates
confounders.name <- c("z_age","z_bm","z_male","ecog","z_histology","z_prior_treat","strat")
dfa <- as.data.frame(df_nonAP)
# Setup parallel processing
library(doFuture)
library(doRNG)
registerDoFuture()
registerDoRNG()
system.time({fs <- forestsearch(dfa,  confounders.name=confounders.name,
outcome.name = "y_sim", treat.name = "treat_sim", event.name = "event_sim", id.name = "id",
potentialOutcome.name = "loghr_po",
df.test = as.data.frame(df_AP),
flag_harm.name = NULL,
hr.threshold = 0.9, hr.consistency = 0.80, pconsistency.threshold = 0.80,
sg_focus = "minSG", max_subgroups_search = 30,
showten_subgroups = TRUE, details=TRUE,
conf_force = c("z_age <= 65", "z_bm <= 0", "z_bm <= 1", "z_bm <= 2","z_bm <= 5"),
cut_type = "default", use_grf = TRUE, plot.grf = TRUE, use_lasso = TRUE,
maxk = 1, n.min = 60, d0.min = 12, d1.min = 12,
plot.sg = TRUE, by.risk = 6,
parallel_args = list(plan="callr", workers = 100, show_message = TRUE)
)
})
plan("sequential")
res_tabs <- sg_tables(fs, ndecimals = 3)
res_tabs$sg10_out
res_tabs$tab_estimates
# Testing (AP)
res_tabs <- sg_tables(fs, ndecimals = 3, which_df = "testing", est_caption = "Testing (AP) dataset")
res_tabs$tab_estimates
confounders.name <- c("z_age","z_bm","z_male","ecog","z_histology","z_prior_treat","strat")
dfa <- as.data.frame(df_nonAP)
# Setup parallel processing
library(doFuture)
library(doRNG)
registerDoFuture()
registerDoRNG()
system.time({fs <- forestsearch(dfa,  confounders.name=confounders.name,
outcome.name = "y_sim", treat.name = "treat_sim", event.name = "event_sim", id.name = "id",
potentialOutcome.name = "loghr_po",
df.test = as.data.frame(df_AP),
flag_harm.name = NULL,
hr.threshold = 1.25, hr.consistency = 0.80, pconsistency.threshold = 0.80,
sg_focus = "minSG", max_subgroups_search = 30,
showten_subgroups = TRUE, details=TRUE,
conf_force = c("z_age <= 65", "z_bm <= 0", "z_bm <= 1", "z_bm <= 2","z_bm <= 5"),
cut_type = "default", use_grf = TRUE, plot.grf = TRUE, use_lasso = TRUE,
maxk = 1, n.min = 60, d0.min = 12, d1.min = 12,
plot.sg = TRUE, by.risk = 6,
parallel_args = list(plan="callr", workers = 100, show_message = TRUE)
)
})
plan("sequential")
res_tabs <- sg_tables(fs, ndecimals = 3)
res_tabs$sg10_out
res_tabs$tab_estimates
# Testing (AP)
res_tabs <- sg_tables(fs, ndecimals = 3, which_df = "testing", est_caption = "Testing (AP) dataset")
res_tabs$tab_estimates
devtools::document()
devtools::load_all()
devtools::document()
devtools::load_all()
unlink("man/*.Rd")
devtools::document()
devtools::load_all()
library(devtools)
github_install("larry-leon/weightedsurv", force = TRUE)
install_github("larry-leon/weightedsurv", force = TRUE)
help(weightedsurv)
library(weightedsurv)
help(weightedsurv)
help(create_baseline_table)
knitr::opts_chunk$set(
echo = TRUE,
warning = FALSE,
message = FALSE,
fig.align = 'center',
fig.retina = 2
)
# Set theme for plots
theme_set(theme_minimal(base_size = 12))
knitr::opts_chunk$set(
echo = TRUE,
warning = FALSE,
message = FALSE,
fig.align = 'center',
fig.retina = 2
)
rm(list=ls())
library(tinytex)
library(ggplot2)
library(table1)
library(gt)
# test these packages
# just for testing any conflicts
# library(tidyverse)
# library(plyr)
# library(dplyr)
# library(glmnet)
library(survival)
library(data.table)
library(randomForest)
library(grf)
library(policytree)
library(DiagrammeR)
library(grid)
library(forestploter)
library(randomizr)
#library(devtools)
#install_github("larry-leon/weightedsurv", force = TRUE)
library(forestsearch)
library(weightedsurv)
# Set theme for plots
theme_set(theme_minimal(base_size = 12))
# case-study example
# Draw sample from synthetic dataset (n=2,000)
dfsynth <- read.table("data/dfsynthetic.csv", header=TRUE, sep=",")
# Consider the "full" dataset
# will sample trials (eg, n=500) below
df.case <- dfsynth
# Draw sample of n=500
# ndraw <- 500
# set.seed(8316951)
# id_draw <- sample(1:nrow(dfsynth), ndraw)
# df.case <- dfsynth[id_draw,]
#names(df.case)
# Original data
dfc <- df_counting(
df = df.case,
by.risk = 6,
tte.name = "tte",
event.name = "event",
treat.name = "treat"
)
plot_weighted_km(dfc, conf.int = TRUE, show.logrank = TRUE, ymax = 1.05)
# Outcome model is NON-stratified (strata_tte=NULL)
# PH
# Create AP region flag
df.case$AP <- df.case$region_asia
# Spline biomarker effects (based on "bm" spline)
dgm_spline <- generate_aft_dgm_flex(
data = df.case,
continuous_vars = c("age", "bm"),
factor_vars = c("male", "histology", "prior_treat","AP"),
set_beta_spec = list(set_var = c("z_AP"), beta_var = -log(5)),
outcome_var = "tte",
event_var = "event",
treatment_var = "treat",
cens_type = "uniform",
subgroup_vars = NULL,
subgroup_cuts = NULL,
model = "alt",
spline_spec = list(
var = "z_bm",  # Use original variable name (or "z_er" if transformed)
knot = 5,
zeta = 10,
log_hrs = log(c(2, 1.25, 0.5))  # HR varies with ER
),
k_inter = 0.0,  # Amplify or turn-off (=0) subgroup per subgroup_vars effect?
verbose = TRUE
)
# dgm_spline <- generate_aft_dgm_flex(
#   data = df.case,
#   continuous_vars = c("bm"),
#   factor_vars = c("AP"),
#   set_beta_spec = list(set_var = c("z_AP"), beta_var = -log(4)),
#   outcome_var = "tte",
#   event_var = "event",
#   treatment_var = "treat",
#   subgroup_vars = NULL,
#   subgroup_cuts = NULL,
#   model = "alt",
#   spline_spec = list(
#     var = "z_bm",  # Use original variable name (or "z_er" if transformed)
#     knot = 2,
#     zeta = 5,
#     log_hrs = log(c(2.5, 1.0, 0.5))  # HR varies with ER
#   ),
#   k_inter = 0.0,  # Amplify or turn-off (=0) subgroup per subgroup_vars effect?
#   verbose = TRUE
# )
# Examine beta = log(hr) parameters
dgm_spline$model_params$b0
cat("AP region parmeter = -log(5)?", c(dgm_spline$model_params$b0["z_AP"],-log(5)),"\n")
